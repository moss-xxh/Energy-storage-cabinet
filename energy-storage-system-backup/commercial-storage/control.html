<!DOCTYPE html>
<html lang="zh-CN" id="html-root">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ§åˆ¶ - å·¥å•†å‚¨èƒ½ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="common-styles.css">
    <style>
        /* æ§åˆ¶é¡µé¢ç‰¹å®šæ ·å¼ */

        /* é¡µé¢æ ‡é¢˜ */
        .page-header {
            margin-bottom: 2rem;
        }

        .page-subtitle {
            color: #64748b;
            font-size: 0.875rem;
        }

        /* æ§åˆ¶é¢æ¿æ ·å¼ */
        .control-sections {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .control-section {
            background: transparent;
            border-radius: 0;
            box-shadow: none;
            overflow: visible;
        }

        .section-header {
            padding: 0;
            border-bottom: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1e293b;
        }

        .section-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
        }

        .status-dot.inactive {
            background: #e2e8f0;
        }

        .section-content {
            padding: 0;
        }

        /* æ§åˆ¶ç½‘æ ¼ */
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .control-label {
            font-size: 0.875rem;
            color: #64748b;
            font-weight: 500;
        }

        .control-value {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* è¾“å…¥æ§ä»¶æ ·å¼ */
        .control-input {
            flex: 1;
            padding: 0.5rem 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: all 200ms ease;
            background: white;
        }
        
        /* æ»‘å—æ ·å¼ */
        .slider-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }
        
        .control-slider {
            flex: 1;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
            position: relative;
            overflow: visible;
        }
        
        .control-slider::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            border-radius: 4px;
            background: var(--fill-color, #3b82f6);
            width: var(--fill-width, 0%);
            pointer-events: none;
            z-index: 1;
        }
        
        /* æ”¾ç”µæ»‘å—ç‰¹æ®Šæ ·å¼ï¼šä»å³ä¾§å¡«å…… */
        #discharge-stop-soc-slider::before {
            left: var(--fill-position, 0%);
        }
        
        /* Webkitå¡«å……æ ·å¼ */
        .control-slider::-webkit-slider-runnable-track {
            height: 8px;
            background: transparent;
            border-radius: 4px;
        }
        
        .control-slider::-moz-range-track {
            height: 8px;
            background: transparent;
            border-radius: 4px;
            border: none;
        }
        
        .control-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: white;
            border: 2px solid #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            position: relative;
            z-index: 2;
            margin-top: -6px; /* å±…ä¸­å¯¹é½ */
        }
        
        .control-slider::-webkit-slider-thumb:hover {
            border-color: #2563eb;
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }
        
        .control-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: white;
            border: 2px solid #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            position: relative;
            z-index: 2;
        }
        
        .control-slider::-moz-range-thumb:hover {
            border-color: #2563eb;
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }
        
        .slider-value {
            min-width: 2rem;
            text-align: center;
            font-weight: 600;
            color: #3b82f6;
            font-size: 0.875rem;
        }
        
        .slider-value-input {
            min-width: 3rem;
            width: 3rem;
            text-align: center;
            font-weight: 600;
            color: #3b82f6;
            font-size: 0.875rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.25rem;
            padding: 0.25rem;
            background: white;
            transition: all 0.2s ease;
        }
        
        .slider-value-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        
        /* å¤é€‰æ¡†ç»„æ ·å¼ */
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            flex: 1;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .checkbox-label {
            font-size: 0.875rem;
            color: #374151;
            cursor: pointer;
        }
        
        /* éœ€é‡ç›‘æ§ç½‘æ ¼ */
        .demand-monitor {
            flex: 1;
        }
        
        .monitor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
        }
        
        .monitor-item {
            text-align: center;
            padding: 0.75rem;
            background: white;
            border-radius: 0.375rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .monitor-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }
        
        .monitor-unit {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }
        
        .monitor-label {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 500;
        }

        .control-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .control-input:disabled {
            background: #f8fafc;
            cursor: not-allowed;
        }

        .control-unit {
            font-size: 0.875rem;
            color: #94a3b8;
            min-width: 40px;
        }

        /* å¼€å…³æ§ä»¶ */
        .switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: .4s;
            border-radius: 24px;
        }

        .switch-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .switch-slider {
            background-color: #3b82f6;
        }

        input:checked + .switch-slider:before {
            transform: translateX(24px);
        }

        /* æŒ‰é’®æ ·å¼ */
        .control-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e2e8f0;
        }

        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 200ms ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #475569;
        }

        .btn-secondary:hover {
            background: #cbd5e1;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .status-card {
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .status-label {
            font-size: 0.75rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .status-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }

        .status-value.success {
            color: #22c55e;
        }

        .status-value.warning {
            color: #f59e0b;
        }

        .status-value.error {
            color: #ef4444;
        }

        /* æ–‡æœ¬å¤„ç† - é˜²æ­¢æº¢å‡º */
        .control-label,
        .section-title,
        .status-label {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* è‹±æ–‡æ¨¡å¼ä¸‹çš„è°ƒæ•´ */
        [lang="en"] .control-label {
            font-size: 0.8125rem;
        }
        
        [lang="en"] .control-grid {
            gap: 1.75rem;
        }
        
        /* å“åº”å¼è®¾è®¡ - æ§åˆ¶é¡µé¢ç‰¹å®š */
        @media (max-width: 1024px) {
            .control-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .control-grid {
                grid-template-columns: 1fr;
            }

            .status-indicators {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- ä¾§è¾¹æ  -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <img src="../logo.png" alt="AlwaysControl Technology Logo">
            </div>
        </div>
        <nav class="sidebar-menu">
            <!-- ç”µç«™ç®¡ç†ï¼ˆå¸¦äºŒçº§èœå•ï¼‰ -->
            <div class="menu-group">
                <div class="menu-parent expanded" onclick="toggleSubmenu(this)">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <span class="menu-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                            </svg>
                        </span>
                        <span data-lang="menu.station">ç”µç«™</span>
                    </div>
                    <span class="menu-arrow">â–¶</span>
                </div>
                <div class="submenu open">
                    <a href="./station-management.html" class="submenu-item">
                        <span data-lang="menu.stationManagement">ç”µç«™ç®¡ç†</span>
                    </a>
                    <a href="./control.html" class="submenu-item active">
                        <span data-lang="menu.control">æ§åˆ¶</span>
                    </a>
                    <a href="./price-settings.html" class="submenu-item">
                        <span data-lang="menu.priceSettings">ç”µä»·è®¾ç½®</span>
                    </a>
                </div>
            </div>
            
            <!-- å…¶ä»–ä¸€çº§èœå• -->
            <a href="./data-analysis.html" class="menu-item">
                <span class="menu-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3v18h18"/>
                        <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/>
                    </svg>
                </span>
                <span data-lang="menu.dataAnalysis">æ•°æ®åˆ†æ</span>
            </a>
            <a href="#" class="menu-item">
                <span class="menu-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                </span>
                <span data-lang="menu.alarmManagement">å‘Šè­¦ç®¡ç†</span>
            </a>
            <a href="#" class="menu-item">
                <span class="menu-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <line x1="12" y1="8" x2="12" y2="16"/>
                        <line x1="8" y1="12" x2="16" y2="12"/>
                    </svg>
                </span>
                <span data-lang="menu.deviceManagement">è®¾å¤‡ç®¡ç†</span>
            </a>
            <a href="#" class="menu-item">
                <span class="menu-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="8.5" cy="7" r="4"/>
                        <line x1="20" y1="8" x2="20" y2="14"/>
                        <line x1="23" y1="11" x2="17" y2="11"/>
                    </svg>
                </span>
                <span data-lang="menu.userManagement">ç”¨æˆ·ç®¡ç†</span>
            </a>
            <a href="#" class="menu-item">
                <span class="menu-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10 9 9 9 8 9"/>
                    </svg>
                </span>
                <span data-lang="menu.reportCenter">æŠ¥è¡¨ä¸­å¿ƒ</span>
            </a>
            <a href="#" class="menu-item">
                <span class="menu-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"/>
                        <path d="M20.5 7.5L16 12l4.5 4.5M3.5 7.5L8 12l-4.5 4.5"/>
                    </svg>
                </span>
                <span data-lang="menu.systemSettings">ç³»ç»Ÿè®¾ç½®</span>
            </a>
            
            <!-- åˆ†éš”çº¿ -->
            <div class="menu-divider"></div>
            <div class="menu-section-title" data-lang="menu.brandControlSystem">å“ç‰Œæ§åˆ¶ç³»ç»Ÿ</div>
            
            <!-- å“ç‰Œæ§åˆ¶èœå• -->
            <a href="./control-sungrow.html" class="menu-item">
                <span class="menu-icon" style="background: #ff6b00; color: white; border-radius: 4px; font-size: 14px;">â˜€ï¸</span>
                <span data-lang="menu.sungrow">é˜³å…‰ç”µæº</span>
            </a>
            <a href="./control-huawei.html" class="menu-item">
                <span class="menu-icon" style="background: #e60012; color: white; border-radius: 4px; font-size: 14px;">ğŸŒŸ</span>
                <span data-lang="menu.huawei">åä¸ºæ™ºèƒ½</span>
            </a>
            <a href="./control-tesla.html" class="menu-item">
                <span class="menu-icon" style="background: #cc0000; color: white; border-radius: 4px; font-size: 14px;">âš¡</span>
                <span data-lang="menu.tesla">ç‰¹æ–¯æ‹‰</span>
            </a>
        </nav>
    </aside>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="content">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <nav class="navbar">
            <div class="navbar-left">
                <button class="nav-button" onclick="toggleSidebar()">
                    <span>â˜°</span>
                </button>
                <button class="nav-button" onclick="goBack()" title="è¿”å›åœºæ™¯é€‰æ‹©">
                    <span>â†</span>
                </button>
                <h1 class="page-title" data-lang="page.deviceControl">è®¾å¤‡æ§åˆ¶</h1>
            </div>
            <div class="navbar-right">
                <button class="nav-button" onclick="toggleLanguage()">
                    <span>ğŸŒ</span>
                    <span id="lang-text">ä¸­æ–‡</span>
                </button>
                <button class="nav-button" onclick="toggleTheme()">
                    <span id="theme-icon">ğŸŒ™</span>
                </button>
                <button class="nav-button">
                    <span>ğŸ‘¤</span>
                    <span>ç®¡ç†å‘˜</span>
                </button>
            </div>
        </nav>

        <!-- é¡µé¢å†…å®¹ -->
        <div class="page-content">
            <!-- å·¥ä½œæ¨¡å¼é€‰æ‹© -->
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <h2 style="font-size: 1.25rem; font-weight: 600; color: #1e293b; margin: 0;" data-lang="control.workMode">è®¾å¤‡å·¥ä½œæ¨¡å¼</h2>
                    <div class="searchable-select" style="position: relative; min-width: 150px;">
                        <input type="text" 
                               id="cabinet-search-input" 
                               placeholder="æœç´¢æˆ–é€‰æ‹©å‚¨èƒ½æŸœ" 
                               style="padding: 0.5rem 2rem 0.5rem 0.75rem; border: 1px solid #e2e8f0; border-radius: 0.375rem; background: white; font-size: 0.875rem; width: 100%;"
                               autocomplete="off">
                        <svg class="dropdown-icon" style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; pointer-events: none; color: #6b7280;" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        <div id="cabinet-dropdown" class="dropdown-list" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e2e8f0; border-radius: 0.375rem; margin-top: 0.25rem; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);">
                            <div class="dropdown-item" data-value="cabinet1" data-demand="80" data-remaining="2000" style="padding: 0.5rem 0.75rem; cursor: pointer; font-size: 0.875rem;">å‚¨èƒ½æŸœ1</div>
                            <div class="dropdown-item" data-value="cabinet2" data-demand="65" data-remaining="3500" style="padding: 0.5rem 0.75rem; cursor: pointer; font-size: 0.875rem;">å‚¨èƒ½æŸœ2</div>
                            <div class="dropdown-item" data-value="cabinet3" data-demand="90" data-remaining="1000" style="padding: 0.5rem 0.75rem; cursor: pointer; font-size: 0.875rem;">å‚¨èƒ½æŸœ3</div>
                            <div class="dropdown-item" data-value="cabinet4" data-demand="45" data-remaining="5500" style="padding: 0.5rem 0.75rem; cursor: pointer; font-size: 0.875rem;">å‚¨èƒ½æŸœ4</div>
                        </div>
                    </div>
                </div>
                <div id="cabinet-info" style="display: flex; gap: 1.5rem; align-items: center; font-size: 0.875rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="color: #64748b;">éœ€é‡:</span>
                        <span id="demand-display" style="font-weight: 600; color: #f59e0b;">80%</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="color: #64748b;">å‰©ä½™:</span>
                        <span id="remaining-display" style="font-weight: 600; color: #3b82f6;">2000kW</span>
                    </div>
                    <!-- æµ‹è¯•æŒ‰é’®ï¼šæ¨¡æ‹Ÿä¸Šå±‚ç³»ç»Ÿæ§åˆ¶VPP -->
                    <button onclick="enableVPPMode(!vppModeEnabled)" style="padding: 0.25rem 0.75rem; background: #f59e0b; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">
                        åˆ‡æ¢VPP
                    </button>
                </div>
            </div>
            <div class="work-mode-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                <div class="mode-card active" onclick="selectWorkMode(this, 'self-consumption')">
                    <div class="mode-icon">â˜€ï¸</div>
                    <div class="mode-title" data-lang="mode.selfConsumption">è‡ªå‘è‡ªç”¨</div>
                    <div class="mode-desc" data-lang="mode.selfConsumptionDesc">ä¼˜å…ˆä½¿ç”¨è‡ªå‘ç”µ</div>
                    <div class="mode-check">âœ“</div>
                </div>
                <div class="mode-card" onclick="selectWorkMode(this, 'economic')">
                    <div class="mode-icon">ğŸ’°</div>
                    <div class="mode-title" data-lang="mode.economic">ç»æµæ¨¡å¼</div>
                    <div class="mode-desc" data-lang="mode.economicDesc">æ™ºèƒ½å¥—åˆ©ä¼˜åŒ–</div>
                    <div class="mode-check">âœ“</div>
                </div>
                <div class="mode-card" onclick="selectWorkMode(this, 'emergency')">
                    <div class="mode-icon">ğŸš¨</div>
                    <div class="mode-title" data-lang="mode.emergency">åº”æ€¥æ¨¡å¼</div>
                    <div class="mode-desc" data-lang="mode.emergencyDesc">å…³é”®è´Ÿè·ä¿éšœ</div>
                    <div class="mode-check">âœ“</div>
                </div>
                <div class="mode-card vpp-disabled" id="vpp-mode-card" onclick="selectWorkMode(this, 'vpp')">
                    <div class="mode-icon">ğŸŒ</div>
                    <div class="mode-title" data-lang="mode.vpp">VPPæ¨¡å¼</div>
                    <div class="mode-desc" data-lang="mode.vppDesc">è™šæ‹Ÿç”µå‚èšåˆ</div>
                    <div class="mode-check">âœ“</div>
                </div>
            </div>


        <style>
            /* Work Mode Cards */
            .mode-card {
                background: white;
                border: 2px solid #e2e8f0;
                border-radius: 0.5rem;
                padding: 1.25rem;
                cursor: pointer;
                text-align: center;
                transition: all 200ms ease;
                position: relative;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }
            
            .mode-card:hover {
                border-color: #60a5fa;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
            }
            
            .mode-card.active {
                background: #eff6ff;
                border-color: #3b82f6;
            }
            
            .mode-icon {
                font-size: 3rem;
                margin-bottom: 0.5rem;
                display: block;
            }
            
            .mode-title {
                font-weight: 600;
                color: #1e293b;
                margin-bottom: 0.25rem;
                font-size: 1rem;
            }
            
            .mode-desc {
                font-size: 0.75rem;
                color: #64748b;
                margin: 0;
            }
            
            .mode-check {
                position: absolute;
                top: 0.5rem;
                right: 0.5rem;
                width: 20px;
                height: 20px;
                background: #3b82f6;
                color: white;
                border-radius: 50%;
                display: none;
                align-items: center;
                justify-content: center;
                font-size: 0.75rem;
            }
            
            .mode-card.active .mode-check {
                display: flex;
            }
            
            /* è‡ªå‘è‡ªç”¨æ¨¡å¼ç‰¹å®šæ ·å¼ */
            .control-description {
                font-size: 0.75rem;
                color: #64748b;
                margin-top: 0.25rem;
                line-height: 1.4;
            }
            
            .control-status {
                margin-left: 0.75rem;
                font-size: 0.875rem;
                color: #22c55e;
                font-weight: 500;
            }
            
            .full-width {
                grid-column: 1 / -1;
            }
            
            /* SOCèŒƒå›´æ˜¾ç¤ºå™¨ */
            .soc-range-display {
                margin-top: 0.5rem;
            }
            
            .soc-bar {
                position: relative;
                height: 24px;
                background: #e2e8f0;
                border-radius: 12px;
                margin-bottom: 0.75rem;
                overflow: hidden;
            }
            
            .soc-range {
                height: 100%;
                background: linear-gradient(90deg, #22c55e 0%, #3b82f6 50%, #f59e0b 100%);
                border-radius: 12px;
                position: relative;
                transition: all 0.3s ease;
            }
            
            .soc-labels {
                display: flex;
                justify-content: space-between;
                position: absolute;
                top: 2px;
                left: 0;
                right: 0;
                bottom: 2px;
                align-items: center;
                padding: 0 8px;
            }
            
            .soc-min, .soc-max {
                background: white;
                color: #1e293b;
                padding: 2px 6px;
                border-radius: 4px;
                font-size: 0.75rem;
                font-weight: 600;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            
            .soc-info {
                font-size: 0.75rem;
                color: #64748b;
                text-align: center;
                line-height: 1.4;
            }
            

            /* 24å°æ—¶æ—¶æ®µé€‰æ‹©å™¨æ ·å¼ */
            .time-selector-section {
                margin-bottom: 2rem;
            }
            
            .time-selector-section h4 {
                margin-bottom: 1rem;
                color: #1e293b;
                font-size: 1rem;
                font-weight: 600;
            }
            
            /* å›¾ä¾‹æ ·å¼ */
            .period-legend {
                display: flex;
                gap: 1.5rem;
                margin-bottom: 1rem;
                justify-content: center;
            }
            
            .legend-item {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                cursor: pointer;
                padding: 0.5rem 0.75rem;
                border-radius: 6px;
                transition: all 0.2s ease;
                font-size: 0.875rem;
                color: #374151;
            }
            
            .legend-item:hover {
                background: #f3f4f6;
            }
            
            .legend-item.active {
                background: #e5e7eb;
                font-weight: 500;
            }
            
            .legend-color {
                width: 20px;
                height: 20px;
                border-radius: 4px;
                border: 1px solid #e5e7eb;
            }
            
            .legend-color.peak-color {
                background: #fee2e2;
                border-color: #f87171;
            }
            
            .legend-color.valley-color {
                background: #dcfce7;
                border-color: #86efac;
            }
            
            .legend-color.normal-color {
                background: #dbeafe;
                border-color: #93c5fd;
            }
            
            .legend-color.clear-color {
                background: #f3f4f6;
                border-color: #d1d5db;
            }

            .time-selector-container {
                background: #f8f9fa;
                border-radius: 8px;
                padding: 20px;
                margin-top: 15px;
            }

            .time-scale {
                display: grid;
                grid-template-columns: 60px repeat(4, 1fr);
                margin-bottom: 10px;
                font-size: 12px;
                color: #666;
            }

            .time-scale-item {
                text-align: center;
            }

            .time-scale-item:first-child {
                text-align: left;
            }

            .hour-selector {
                display: grid;
                grid-template-columns: 60px repeat(24, 1fr);
                gap: 0;
                align-items: center;
            }

            .hour-label {
                font-size: 12px;
                color: #666;
                text-align: right;
                padding-right: 10px;
                font-weight: 500;
            }

            .hour-cell {
                height: 40px;
                background: white;
                border: 1px solid #ddd;
                border-right: none;
                cursor: pointer;
                position: relative;
                transition: all 0.2s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
                font-weight: 500;
            }
            
            .hour-cell:last-child {
                border-right: 1px solid #ddd;
            }
            
            .hour-cell:first-child {
                border-radius: 4px 0 0 4px;
            }
            
            .hour-cell:last-child {
                border-radius: 0 4px 4px 0;
            }

            .hour-cell:hover {
                transform: translateY(-2px);
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }

            .hour-cell.peak {
                background: #fee2e2;
                border-color: #f87171;
                color: #dc2626;
            }

            .hour-cell.valley {
                background: #dcfce7;
                border-color: #86efac;
                color: #16a34a;
            }

            .hour-cell.normal {
                background: #dbeafe;
                border-color: #93c5fd;
                color: #2563eb;
            }

            .hour-cell .hour-number {
                font-size: 10px;
                color: #999;
                position: absolute;
                top: 2px;
                left: 50%;
                transform: translateX(-50%);
                transition: opacity 0.2s ease;
            }
            
            /* Hide hour numbers when cell has a period type */
            .hour-cell.peak .hour-number,
            .hour-cell.valley .hour-number,
            .hour-cell.normal .hour-number {
                opacity: 0;
            }
            
            .hour-cell .period-text {
                font-size: 14px;
                font-weight: 600;
            }
            
            /* Prevent text selection during drag */
            .hour-selector {
                user-select: none;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
            }

            /* å¼€å…³æ ·å¼ */
            .switch input:checked + .slider {
                background-color: #3b82f6;
            }

            .switch .slider:before {
                position: absolute;
                content: "";
                height: 20px;
                width: 20px;
                left: 3px;
                bottom: 3px;
                background-color: white;
                transition: .4s;
                border-radius: 50%;
            }

            .switch input:checked + .slider:before {
                transform: translateX(24px);
            }

            .hour-labels {
                display: grid;
                grid-template-columns: 60px repeat(24, 1fr);
                gap: 0;
                margin-top: 5px;
                font-size: 10px;
                color: #999;
            }

            .hour-labels > div {
                text-align: center;
            }

            .quick-actions {
                margin-top: 1rem;
                display: flex;
                gap: 0.75rem;
            }
            
            /* Tab æ ·å¼ - ç®€çº¦è®¾è®¡ï¼Œä¸ç•Œé¢é£æ ¼ç»Ÿä¸€ */
            .mode-tabs {
                margin-top: 0;
                margin-bottom: 0;
            }
            
            .tab-nav {
                display: flex;
                gap: 0;
                margin-bottom: 0;
                border-bottom: 2px solid #e2e8f0;
                padding-bottom: -2px;
            }
            
            .tab-button {
                padding: 0.75rem 3rem 0.75rem 1.5rem;
                border: none;
                position: relative;
                background: none;
                cursor: pointer;
                color: #64748b;
                font-weight: 500;
                transition: all 150ms ease;
                position: relative;
                border-bottom: 2px solid transparent;
                margin-bottom: -2px;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                font-size: 0.875rem;
            }
            
            .tab-button:hover {
                color: #1e293b;
            }
            
            .tab-button.active {
                color: #3562E3;
                border-bottom-color: #3562E3;
                background: none !important;
            }
            
            .tab-icon {
                font-size: 1rem;
            }
            
            
            /* Tab å†…å®¹åŒºåŸŸ */
            .tab-content-wrapper {
                padding: 0;
                margin-top: 2rem;
            }
            
            .tab-panel {
                display: none;
            }
            
            .tab-panel.active {
                display: block;
            }
            
            /* ç§»é™¤åŸæœ‰çš„ margin-top */
            .tab-panel h2 {
                margin-top: 0 !important;
            }
            
            /* ç¼–è¾‘æŒ‰é’®æ ·å¼ */
            .tab-edit-btn {
                position: absolute;
                top: 50%;
                right: 0.75rem;
                transform: translateY(-50%);
                padding: 0.25rem 0.75rem;
                background: #f1f5f9;
                border: 1px solid #e2e8f0;
                border-radius: 4px;
                cursor: pointer;
                color: #64748b;
                font-size: 0.75rem;
                font-weight: 500;
                display: none;
                transition: all 0.2s ease;
                z-index: 10;
            }
            
            .tab-button.active .tab-edit-btn {
                display: block;
            }
            
            .tab-edit-btn:hover {
                color: #3b82f6;
                background: #e0e7ff;
                border-color: #3b82f6;
            }
            
            .tab-edit-btn.editing {
                color: white;
                background: #22c55e;
                border-color: #22c55e;
            }
            
            /* åªè¯»æ¨¡å¼æ ·å¼ */
            .readonly-mode input,
            .readonly-mode select,
            .readonly-mode textarea,
            .readonly-mode .switch input {
                pointer-events: none;
                opacity: 0.7;
            }
            
            .readonly-mode .control-input {
                background: #f8fafc;
                cursor: not-allowed;
            }
            
            /* ç»æµæ¨¡å¼åªè¯»æ—¶ç¦ç”¨æ‰€æœ‰äº¤äº’å…ƒç´  */
            .readonly-mode .switch {
                pointer-events: none;
                opacity: 0.7;
            }
            
            .readonly-mode .legend-item {
                pointer-events: none;
                opacity: 0.7;
                cursor: not-allowed;
            }
            
            .readonly-mode .hour-grid {
                pointer-events: none;
                opacity: 0.7;
            }
            
            .readonly-mode .hour-selector {
                pointer-events: none;
                opacity: 0.7;
            }
            
            .readonly-mode .time-selector-section {
                pointer-events: none;
                opacity: 0.8;
            }
            
            /* å…±äº«å‚æ•°ç‰¹å®šçš„åªè¯»æ¨¡å¼æ ·å¼ */
            .shared-params-section.readonly-mode input[type="checkbox"],
            .shared-params-section.readonly-mode .checkbox-item input {
                pointer-events: none;
                cursor: not-allowed;
            }
            
            .shared-params-section.readonly-mode .checkbox-item {
                opacity: 0.7;
            }
            
            .shared-params-section.readonly-mode .switch {
                opacity: 0.7;
                pointer-events: none;
            }
            
            /* ä¿å­˜ç¡®è®¤å¯¹è¯æ¡† */
            .save-dialog {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border-radius: 0.5rem;
                box-shadow: 0 10px 50px rgba(0, 0, 0, 0.2);
                z-index: 1000;
                padding: 1.5rem;
                min-width: 300px;
            }
            
            .save-dialog-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
            }
            
            /* å¯æœç´¢ä¸‹æ‹‰æ¡†æ ·å¼ */
            .dropdown-item:hover {
                background: #f3f4f6;
            }
            
            .dropdown-item.active {
                background: #eff6ff;
                color: #3b82f6;
            }
            
            /* é€šç”¨è®¾ç½®ç¼–è¾‘æŒ‰é’®æ ·å¼ */
            .shared-edit-btn {
                padding: 0.25rem 0.75rem;
                background: #3b82f6;
                border: 1px solid #3b82f6;
                border-radius: 4px;
                cursor: pointer;
                color: white;
                font-size: 0.75rem;
                font-weight: 500;
                transition: all 0.2s ease;
            }
            
            .shared-edit-btn:hover {
                background: #2563eb;
                border-color: #2563eb;
            }
            
            .shared-edit-btn.editing {
                background: #22c55e;
                border-color: #22c55e;
            }
            
            /* VPPæ¨¡å¼ç¦ç”¨æ ·å¼ */
            .mode-card.vpp-disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            
            .mode-card.vpp-disabled:hover {
                transform: none;
                border-color: #e2e8f0;
            }
            
            .mode-card.vpp-active {
                background: #fef3c7;
                border-color: #f59e0b;
            }
            
            .mode-card.vpp-active .mode-desc {
                color: #f59e0b;
                font-weight: 600;
            }
            
            /* å…±äº«å‚æ•°åŒºåŸŸæ ·å¼ */
            .shared-params-section {
                margin-top: 0;
                margin-bottom: 0;
                background: #f8f9fa;
                padding: 1.5rem;
                border-radius: 0.5rem;
            }
            
            .shared-params-section h3 {
                color: #3b82f6;
                margin-bottom: 1rem;
            }
            
            .shared-params-section .control-section {
                background: transparent;
                border: none;
            }

        </style>


        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-sections" id="control-sections">
            <!-- æ¨¡å¼è®¾ç½® Tab å¯¼èˆª -->
            <div class="mode-tabs">
                <div class="tab-nav">
                    <button class="tab-button active" onclick="switchModeTab('self-consumption')" data-lang="mode.selfConsumption">
                        <span class="tab-icon">â˜€ï¸</span>
                        <span>è‡ªå‘è‡ªç”¨</span>
                        <button class="tab-edit-btn" onclick="toggleEditMode('self-consumption', event)" title="ç¼–è¾‘">
                            ç¼–è¾‘
                        </button>
                    </button>
                    <button class="tab-button" onclick="switchModeTab('economic')" data-lang="mode.economic">
                        <span class="tab-icon">ğŸ’°</span>
                        <span>ç»æµæ¨¡å¼</span>
                        <button class="tab-edit-btn" onclick="toggleEditMode('economic', event)" title="ç¼–è¾‘">
                            ç¼–è¾‘
                        </button>
                    </button>
                    <button class="tab-button" onclick="switchModeTab('emergency')" data-lang="mode.emergency">
                        <span class="tab-icon">ğŸš¨</span>
                        <span>åº”æ€¥æ¨¡å¼</span>
                        <button class="tab-edit-btn" onclick="toggleEditMode('emergency', event)" title="ç¼–è¾‘">
                            ç¼–è¾‘
                        </button>
                    </button>
                </div>
            </div>
            
            <!-- å…±äº«å‚æ•°åŒºåŸŸ -->
            <div style="background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; padding: 1.5rem; margin-top: 24px;">
                <div class="shared-params-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="font-size: 1rem; font-weight: 600; color: #1e293b; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                        <span>ğŸ”§</span>
                        <span data-lang="shared.commonSettings">é€šç”¨è®¾ç½®</span>
                    </h3>
                    <button class="shared-edit-btn" onclick="toggleSharedEditMode(event)" title="ç¼–è¾‘">
                        ç¼–è¾‘
                    </button>
                </div>
                <div class="shared-params-section">
                <section class="control-section">
                    <div class="section-content">
                        <div class="control-grid">
                            <!-- å……ç”µåœæ­¢SOC - æ»‘å— -->
                            <div class="control-item">
                                <label class="control-label" data-lang="selfConsumption.chargeStopSoc">å……ç”µåœæ­¢SOC</label>
                                <div class="control-value">
                                    <div class="slider-container">
                                        <input type="range" class="control-slider" value="95" min="0" max="100" id="charge-stop-soc-slider" oninput="updateSliderValue(this, 'charge-stop-soc-value')">
                                        <input type="number" class="slider-value-input" id="charge-stop-soc-value" value="95" min="0" max="100" oninput="updateSliderFromInput(this, 'charge-stop-soc-slider')">
                                        <span class="control-unit">%</span>
                                    </div>
                                </div>
                                <div class="control-description" data-lang="selfConsumption.chargeStopSocDesc">é˜²æ­¢è¿‡å……</div>
                            </div>
                            
                            <!-- æ”¾ç”µåœæ­¢SOC - æ»‘å— -->
                            <div class="control-item">
                                <label class="control-label" data-lang="selfConsumption.dischargeStopSoc">æ”¾ç”µåœæ­¢SOC</label>
                                <div class="control-value">
                                    <div class="slider-container">
                                        <input type="range" class="control-slider" value="20" min="5" max="100" id="discharge-stop-soc-slider" oninput="updateSliderValue(this, 'discharge-stop-soc-value')">
                                        <input type="number" class="slider-value-input" id="discharge-stop-soc-value" value="20" min="5" max="100" oninput="updateSliderFromInput(this, 'discharge-stop-soc-slider')">
                                        <span class="control-unit">%</span>
                                    </div>
                                </div>
                                <div class="control-description" data-lang="selfConsumption.dischargeStopSocDesc">é˜²æ­¢è¿‡æ”¾</div>
                            </div>
                            
                            <!-- ä½™ç”µä¸Šç½‘å¼€å…³ -->
                            <div class="control-item">
                                <label class="control-label" data-lang="selfConsumption.excessPvExport">ä½™ç”µä¸Šç½‘</label>
                                <div class="control-value">
                                    <label class="switch">
                                        <input type="checkbox" id="excess-pv-export-shared" checked>
                                        <span class="switch-slider"></span>
                                    </label>
                                    <span class="control-status" data-lang="selfConsumption.exportEnabled">å…è®¸</span>
                                </div>
                                <div class="control-description" data-lang="selfConsumption.excessPvExportDesc">å½“å…‰ä¼å‘ç”µè¶…è¿‡è´Ÿè·éœ€æ±‚ä¸”ç”µæ± å·²æ»¡æ—¶ï¼Œå…è®¸ä½™ç”µä¸Šç½‘é”€å”®</div>
                            </div>
                            
                            <!-- ç”µæ± å……ç”µåŠŸç‡ -->
                            <div class="control-item">
                                <label class="control-label" data-lang="shared.batteryChargePower">ç”µæ± å……ç”µåŠŸç‡</label>
                                <div class="control-value">
                                    <input type="number" class="control-input" value="500" min="0" max="6000" id="battery-charge-power">
                                    <span class="control-unit">W</span>
                                </div>
                                <div class="control-description" data-lang="shared.batteryPowerDesc">å¯è®¾ç½®èŒƒå›´0â€”â€”6000W</div>
                            </div>
                            
                            <!-- ç”µæ± æ”¾ç”µåŠŸç‡ -->
                            <div class="control-item">
                                <label class="control-label" data-lang="shared.batteryDischargePower">ç”µæ± æ”¾ç”µåŠŸç‡</label>
                                <div class="control-value">
                                    <input type="number" class="control-input" value="500" min="0" max="6000" id="battery-discharge-power">
                                    <span class="control-unit">W</span>
                                </div>
                                <div class="control-description" data-lang="shared.batteryPowerDesc">å¯è®¾ç½®èŒƒå›´0â€”â€”6000W</div>
                            </div>
                            
                            <!-- éœ€é‡è®¾ç½®å°æ ‡é¢˜ -->
                            <div class="control-item full-width" style="margin-top: 1.5rem; margin-bottom: 0.5rem;">
                                <div style="display: flex; align-items: center; gap: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e2e8f0;">
                                    <h4 style="font-size: 1rem; font-weight: 600; color: #374151; margin: 0;">
                                        éœ€é‡è®¾ç½®
                                    </h4>
                                    <label class="switch">
                                        <input type="checkbox" id="demand-settings-enabled" checked>
                                        <span class="switch-slider"></span>
                                    </label>
                                    <span class="status-text" style="font-size: 0.875rem; color: #3b82f6;" data-lang="shared.enabled">å·²å¯ç”¨</span>
                                </div>
                            </div>
                            
                            <!-- éœ€é‡æ§åˆ¶è®¾ç½® -->
                            <div class="control-item">
                                <label class="control-label" data-lang="demand.contractCapacity">åˆåŒå®¹é‡</label>
                                <div class="control-value">
                                    <input type="number" class="control-input" value="1000" min="100" max="10000" id="contract-capacity">
                                    <span class="control-unit">kW</span>
                                </div>
                                <div class="control-description" data-lang="demand.contractCapacityDesc">ä¸ç”µç½‘ç­¾è®¢çš„æœ€å¤§éœ€é‡åˆåŒå®¹é‡</div>
                            </div>
                            
                            <div class="control-item">
                                <label class="control-label" data-lang="demand.warningPercentage">é¢„è­¦ç™¾åˆ†æ¯”</label>
                                <div class="control-value">
                                    <input type="number" class="control-input" value="90" min="50" max="100" id="warning-percentage">
                                    <span class="control-unit">%</span>
                                </div>
                                <div class="control-description" data-lang="demand.warningPercentageDesc">å½“éœ€é‡è¾¾åˆ°åˆåŒå®¹é‡çš„æ­¤ç™¾åˆ†æ¯”æ—¶è§¦å‘é¢„è­¦</div>
                            </div>
                            
                            <div class="control-item">
                                <label class="control-label" data-lang="demand.calculationPeriod">éœ€é‡è®¡ç®—å‘¨æœŸ</label>
                                <div class="control-value">
                                    <select class="control-input" id="demand-calculation-period">
                                        <option value="15" data-lang="demand.period15">15åˆ†é’Ÿ</option>
                                        <option value="30" data-lang="demand.period30">30åˆ†é’Ÿ</option>
                                        <option value="60" data-lang="demand.period60">60åˆ†é’Ÿ</option>
                                    </select>
                                </div>
                                <div class="control-description" data-lang="demand.calculationPeriodDesc">ç”µç½‘è®¡è´¹çš„éœ€é‡ç»Ÿè®¡å‘¨æœŸ</div>
                            </div>
                            
                            <div class="control-item full-width">
                                <label class="control-label" data-lang="demand.overLimitStrategy">éœ€é‡è¶…é™å¤„ç†ç­–ç•¥</label>
                                <div class="control-value">
                                    <div class="checkbox-group">
                                        <label class="checkbox-item">
                                            <input type="checkbox" id="strategy-discharge" checked>
                                            <span class="checkbox-label" data-lang="demand.emergencyDischarge">ç´§æ€¥æ”¾ç”µ (ç«‹å³ä»¥æœ€å¤§åŠŸç‡æ”¾ç”µ)</span>
                                        </label>
                                        <label class="checkbox-item">
                                            <input type="checkbox" id="strategy-load-shedding">
                                            <span class="checkbox-label" data-lang="demand.loadShedding">è´Ÿè·åˆ‡é™¤ (è‡ªåŠ¨åˆ‡é™¤éå…³é”®è´Ÿè·)</span>
                                        </label>
                                        <label class="checkbox-item">
                                            <input type="checkbox" id="strategy-alarm" checked>
                                            <span class="checkbox-label" data-lang="demand.alarmNotify">å‘Šè­¦é€šçŸ¥ (å‘é€è¶…é™é¢„è­¦)</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="control-description" data-lang="demand.overLimitStrategyDesc">å½“é¢„æµ‹éœ€é‡å°†è¶…è¿‡ç›®æ ‡å€¼æ—¶çš„å¤„ç†æªæ–½</div>
                            </div>
                            
                        </div>
                    </div>
                </section>
            </div>
            <!-- ç¼–è¾‘æ¨¡å¼æŒ‰é’® -->
            <div class="shared-edit-actions" style="display: none; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0; text-align: right;">
                <button class="cancel-btn" onclick="cancelSharedEdit()" style="padding: 0.5rem 1.5rem; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; margin-right: 0.75rem; font-size: 0.875rem;">
                    å–æ¶ˆ
                </button>
                <button class="save-btn" onclick="saveSharedEdit()" style="padding: 0.5rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">
                    ä¿å­˜
                </button>
            </div>
            </div>

            <!-- Tab å†…å®¹åŒºåŸŸ -->
            <div class="tab-content-wrapper">
                <!-- è‡ªå‘è‡ªç”¨æ¨¡å¼å‚æ•° -->
                <div class="tab-panel active" id="self-consumption-panel">
                </div>

            <!-- ç»æµæ¨¡å¼è®¾ç½® -->
            <div class="tab-panel" id="economic-panel">
                <div style="background: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                    <h2 style="font-size: 1.25rem; font-weight: 600; color: #1e293b; margin-bottom: 1rem; margin-top: 0; display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 1.5rem;">ğŸ’°</span>
                        <span data-lang="mode.economic">ç»æµæ¨¡å¼</span>
                    </h2>
                    <!-- ç»æµæ¨¡å¼æ ¸å¿ƒè®¾ç½® -->
                    <section class="control-section">
                    <div class="section-content">
                        <!-- 24å°æ—¶æ—¶æ®µé€‰æ‹©å™¨ -->
                        <div class="time-selector-section">
                            <!-- å›¾ä¾‹ -->
                            <div class="period-legend">
                                <div class="legend-item peak-legend" onclick="selectPeriodType('peak')">
                                    <span class="legend-color peak-color"></span>
                                    <span data-lang="economic.peakType">å³°æ—¶æ®µ</span>
                                </div>
                                <div class="legend-item valley-legend" onclick="selectPeriodType('valley')">
                                    <span class="legend-color valley-color"></span>
                                    <span data-lang="economic.valleyType">è°·æ—¶æ®µ</span>
                                </div>
                                <div class="legend-item normal-legend" onclick="selectPeriodType('normal')">
                                    <span class="legend-color normal-color"></span>
                                    <span data-lang="economic.normalType">å¹³æ—¶æ®µ</span>
                                </div>
                            </div>
                            
                            <div class="time-selector-container">
                                <!-- æ—¶é—´åˆ»åº¦ -->
                                <div class="time-scale">
                                    <div class="time-scale-item"></div>
                                    <div class="time-scale-item"></div>
                                    <div class="time-scale-item"></div>
                                    <div class="time-scale-item"></div>
                                    <div class="time-scale-item"></div>
                                </div>
                                
                                <!-- 24å°æ—¶é€‰æ‹©æ ¼ -->
                                <div class="hour-selector" id="hour-selector">
                                    <!-- å°†é€šè¿‡JavaScriptç”Ÿæˆ24ä¸ªå°æ—¶æ ¼ -->
                                </div>
                                
                                <!-- æ—¶é—´æ ‡ç­¾ -->
                                <div class="hour-labels">
                                    <!-- å°†é€šè¿‡JavaScriptç”Ÿæˆå°æ—¶æ ‡ç­¾ -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- ç”µç½‘å……ç”µè®¾ç½® -->
                        <div style="margin-top: 20px; display: flex; align-items: center; gap: 1rem;">
                            <label style="font-size: 0.875rem; color: #1e293b; font-weight: 600; white-space: nowrap;" data-lang="economic.gridCharging">æ˜¯å¦å…è®¸ç”µç½‘ç»™ç”µæ± å……ç”µ</label>
                            <label class="switch">
                                <input type="checkbox" id="grid-charging-enabled">
                                <span class="switch-slider"></span>
                            </label>
                            <span style="font-size: 0.875rem; color: #64748b; font-weight: 500;" id="grid-charging-status" data-lang="economic.gridChargingNotAllowed">ä¸å…è®¸</span>
                        </div>
                        
                        <!-- å¹³æ—¶æ®µä¼˜å…ˆçº§ç­–ç•¥ -->
                        <div style="margin-top: 20px; margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <label style="font-size: 0.875rem; color: #1e293b; font-weight: 600; white-space: nowrap;" data-lang="economic.normalPriority">å¹³æ—¶æ®µä¼˜å…ˆçº§ç­–ç•¥</label>
                                <select style="width: 150px; padding: 0.5rem 0.75rem; border: 1px solid #e2e8f0; border-radius: 0.375rem; font-size: 0.875rem; background: white; cursor: pointer;" id="normal-priority-strategy">
                                    <option value="charge-first" data-lang="economic.chargeFirst">å……ç”µä¼˜å…ˆ</option>
                                    <option value="export-first" data-lang="economic.exportFirst">ä¸Šç½‘ä¼˜å…ˆ</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    </section>
                    <!-- ç»æµæ¨¡å¼ç¼–è¾‘æŒ‰é’® -->
                    <div class="economic-edit-actions" style="display: none; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0; text-align: right;">
                        <button class="cancel-btn" onclick="cancelEconomicEdit()" style="padding: 0.5rem 1.5rem; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; margin-right: 0.75rem; font-size: 0.875rem;">
                            å–æ¶ˆ
                        </button>
                        <button class="save-btn" onclick="saveEconomicEdit()" style="padding: 0.5rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">
                            ä¿å­˜
                        </button>
                    </div>
                </div>
            </div>


            </div> <!-- end tab-content -->

        </div>
        </div>
    </main>

    <script src="common-scripts.js"></script>
    <script>
        // è¯­è¨€æ•°æ®
        const translations = {
            zh: {
                // èœå•
                'menu.station': 'ç”µç«™',
                'menu.stationManagement': 'ç”µç«™ç®¡ç†',
                'menu.control': 'æ§åˆ¶',
                'menu.priceSettings': 'ç”µä»·è®¾ç½®',
                'menu.dataAnalysis': 'æ•°æ®åˆ†æ',
                'menu.alarmManagement': 'å‘Šè­¦ç®¡ç†',
                'menu.deviceManagement': 'è®¾å¤‡ç®¡ç†',
                'menu.userManagement': 'ç”¨æˆ·ç®¡ç†',
                'menu.reportCenter': 'æŠ¥è¡¨ä¸­å¿ƒ',
                'menu.systemSettings': 'ç³»ç»Ÿè®¾ç½®',
                'menu.brandControlSystem': 'å“ç‰Œæ§åˆ¶ç³»ç»Ÿ',
                'menu.sungrow': 'é˜³å…‰ç”µæº',
                'menu.huawei': 'åä¸ºæ™ºèƒ½',
                'menu.tesla': 'ç‰¹æ–¯æ‹‰',
                
                // é¡µé¢
                'page.deviceControl': 'è®¾å¤‡æ§åˆ¶',
                
                // å·¥ä½œæ¨¡å¼
                'control.workMode': 'è®¾å¤‡å·¥ä½œæ¨¡å¼',
                'control.workModeDesc': 'é€‰æ‹©å‚¨èƒ½ç³»ç»Ÿçš„è¿è¡Œæ¨¡å¼',
                'control.selectCabinet': 'é€‰æ‹©å‚¨èƒ½æŸœ',
                'mode.selfConsumption': 'è‡ªå‘è‡ªç”¨',
                'mode.selfConsumptionDesc': 'ä¼˜å…ˆä½¿ç”¨è‡ªå‘ç”µ',
                'mode.economic': 'ç»æµæ¨¡å¼',
                'mode.economicDesc': 'æ™ºèƒ½å¥—åˆ©ä¼˜åŒ–',
                'mode.emergency': 'åº”æ€¥æ¨¡å¼',
                'mode.emergencyDesc': 'å…³é”®è´Ÿè·ä¿éšœ',
                'mode.demand': 'éœ€é‡æ§åˆ¶',
                'mode.demandDesc': 'å‰Šå³°é™å®¹ä¼˜åŒ–',
                'mode.vpp': 'VPPæ¨¡å¼',
                'mode.vppDesc': 'è™šæ‹Ÿç”µå‚èšåˆ',
                
                // å…±äº«å‚æ•°
                'shared.commonSettings': 'é€šç”¨è®¾ç½®',
                'shared.maxSoc': 'æœ€å¤§SOCé™åˆ¶',
                'shared.maxSocDesc': 'æ‰€æœ‰æ¨¡å¼ä¸‹ç”µæ± å……ç”µçš„æœ€å¤§SOCé™åˆ¶',
                'shared.minSoc': 'æœ€å°SOCé™åˆ¶',
                'shared.minSocDesc': 'æ‰€æœ‰æ¨¡å¼ä¸‹ç”µæ± æ”¾ç”µçš„æœ€å°SOCé™åˆ¶',
                'shared.maxChargePower': 'æœ€å¤§å……ç”µåŠŸç‡',
                'shared.maxChargePowerDesc': 'ç³»ç»Ÿæœ€å¤§å……ç”µåŠŸç‡é™åˆ¶',
                'shared.maxDischargePower': 'æœ€å¤§æ”¾ç”µåŠŸç‡',
                'shared.maxDischargePowerDesc': 'ç³»ç»Ÿæœ€å¤§æ”¾ç”µåŠŸç‡é™åˆ¶',
                'shared.batteryChargePower': 'ç”µæ± å……ç”µåŠŸç‡',
                'shared.batteryDischargePower': 'ç”µæ± æ”¾ç”µåŠŸç‡',
                'shared.batteryPowerDesc': 'å¯è®¾ç½®èŒƒå›´0â€”â€”6000W',
                'shared.tempProtection': 'æ¸©åº¦ä¿æŠ¤',
                'shared.tempProtectionDesc': 'å¯ç”¨ç”µæ± æ¸©åº¦ä¿æŠ¤åŠŸèƒ½',
                'shared.enabled': 'å·²å¯ç”¨',
                'shared.disabled': 'å·²ç¦ç”¨',
                'shared.commProtocol': 'é€šä¿¡åè®®',
                'shared.commProtocolDesc': 'ä¸å¤–éƒ¨ç³»ç»Ÿçš„é€šä¿¡åè®®',
                'shared.modbus': 'Modbus TCP',
                'shared.canbus': 'CAN Bus',
                'shared.ethercat': 'EtherCAT',
                
                // è‡ªå‘è‡ªç”¨æ¨¡å¼
                'selfConsumption.coreSettings': 'è‡ªå‘è‡ªç”¨æ¨¡å¼è®¾ç½®',
                'selfConsumption.chargeStopSoc': 'å……ç”µåœæ­¢SOC',
                'selfConsumption.chargeStopSocDesc': 'é˜²æ­¢è¿‡å……',
                'selfConsumption.dischargeStopSoc': 'æ”¾ç”µåœæ­¢SOC',
                'selfConsumption.dischargeStopSocDesc': 'é˜²æ­¢è¿‡æ”¾ï¼ˆè®¾ç½®è¶Šé«˜ï¼Œåœç”µæœŸé—´ä½¿ç”¨èƒ½æºè¶Šå¤šï¼‰',
                'selfConsumption.excessPvExport': 'ä½™ç”µä¸Šç½‘',
                'selfConsumption.exportEnabled': 'å…è®¸',
                'selfConsumption.exportDisabled': 'ä¸å…è®¸',
                'selfConsumption.excessPvExportDesc': 'å½“å…‰ä¼å‘ç”µè¶…è¿‡è´Ÿè·éœ€æ±‚ä¸”ç”µæ± å·²æ»¡æ—¶ï¼Œå…è®¸ä½™ç”µä¸Šç½‘é”€å”®',
                'selfConsumption.socRange': 'SOCå·¥ä½œèŒƒå›´',
                'selfConsumption.socRangeInfo': 'ç”µæ± å°†åœ¨æ­¤SOCèŒƒå›´å†…å·¥ä½œï¼Œç¡®ä¿æœ€ä½³æ€§èƒ½å’Œå¯¿å‘½',
                'selfConsumption.exportSettings': 'ä¿å­˜é…ç½®',
                
                // ç»æµæ¨¡å¼
                'economic.coreSettings': 'ç»æµæ¨¡å¼è®¾ç½®',
                'economic.timePeriodTitle': 'ç”µä»·æ—¶æ®µè®¾ç½®',
                'economic.timePeriodDesc': 'è®¾ç½®å³°è°·ç”µä»·æ—¶æ®µï¼Œç³»ç»Ÿå°†åœ¨è°·æ—¶æ®µå……ç”µï¼Œå³°æ—¶æ®µæ”¾ç”µï¼Œå®ç°å¥—åˆ©æ”¶ç›Šæœ€å¤§åŒ–',
                'economic.peakPeriod': 'å³°æ—¶æ®µè®¾ç½®',
                'economic.peakTime': 'å³°æ—¶æ®µï¼ˆé«˜ç”µä»·ï¼‰',
                'economic.peakPrice': 'å³°æ—¶ç”µä»·',
                'economic.valleyPeriod': 'è°·æ—¶æ®µè®¾ç½®',
                'economic.valleyTime': 'è°·æ—¶æ®µï¼ˆä½ç”µä»·ï¼‰',
                'economic.valleyPrice': 'è°·æ—¶ç”µä»·',
                'economic.normalPeriod': 'å¹³æ—¶æ®µè®¾ç½®',
                'economic.normalTime': 'å¹³æ—¶æ®µï¼ˆæ ‡å‡†ç”µä»·ï¼‰',
                'economic.normalPrice': 'å¹³æ—¶ç”µä»·',
                'economic.normalNote': 'å¹³æ—¶æ®µä¸ºé™¤å³°è°·æ—¶æ®µå¤–çš„å…¶ä»–æ—¶é—´',
                'economic.timeRange': 'æ—¶é—´æ®µ',
                'economic.addTimeSlot': '+ æ·»åŠ æ—¶æ®µ',
                'economic.timePreview': '24å°æ—¶æ—¶æ®µé¢„è§ˆ',
                'economic.peakLegend': 'å³°æ—¶æ®µ',
                'economic.valleyLegend': 'è°·æ—¶æ®µ',
                'economic.normalLegend': 'å¹³æ—¶æ®µ',
                'economic.exportSettings': 'ä¿å­˜é…ç½®',
                'economic.selectPeriodType': 'é€‰æ‹©æ—¶æ®µç±»å‹',
                'economic.peakType': 'å³°æ—¶æ®µ',
                'economic.valleyType': 'è°·æ—¶æ®µ',
                'economic.normalType': 'å¹³æ—¶æ®µ',
                'economic.clearType': 'æ¸…é™¤',
                'economic.hourlySelector': '24å°æ—¶æ—¶æ®µè®¾ç½®',
                'economic.clearAll': 'å…¨éƒ¨æ¸…é™¤',
                'economic.commercialPreset': 'å·¥å•†ä¸šé¢„è®¾',
                'economic.industrialPreset': 'å·¥ä¸šé¢„è®¾',
                'economic.priceSettings': 'ç”µä»·è®¾ç½®',
                'economic.periodStats': 'æ—¶æ®µç»Ÿè®¡',
                'economic.peakHours': 'å³°æ—¶æ®µæ—¶é•¿ï¼š',
                'economic.valleyHours': 'è°·æ—¶æ®µæ—¶é•¿ï¼š',
                'economic.normalHours': 'å¹³æ—¶æ®µæ—¶é•¿ï¼š',
                'economic.normalPriority': 'å¹³æ—¶æ®µä¼˜å…ˆçº§ç­–ç•¥',
                'economic.normalPriorityDesc': 'è®¾ç½®å¹³æ—¶æ®µç”µæ± çš„å……æ”¾ç”µä¼˜å…ˆçº§ç­–ç•¥',
                'economic.chargeFirst': 'å……ç”µä¼˜å…ˆ',
                'economic.exportFirst': 'ä¸Šç½‘ä¼˜å…ˆ',
                'economic.gridCharging': 'æ˜¯å¦å…è®¸ç”µç½‘ç»™ç”µæ± å……ç”µ',
                'economic.gridChargingAllowed': 'å…è®¸',
                'economic.gridChargingNotAllowed': 'ä¸å…è®¸',
                
                // åº”æ€¥æ¨¡å¼
                'emergency.backupSocReserve': 'å¤‡ç”µSOCä¿ç•™',
                'emergency.backupSocReserveDesc': 'é¢„ç•™ç”µæ± å®¹é‡ç”¨äºåº”æ€¥ä¾›ç”µï¼Œç¡®ä¿å…³é”®è´Ÿè·ä¾›ç”µå®‰å…¨',
                'emergency.criticalLoadPower': 'å…³é”®è´Ÿè·åŠŸç‡',
                'emergency.criticalLoadPowerDesc': 'åº”æ€¥æ¨¡å¼ä¸‹éœ€è¦ä¿éšœçš„å…³é”®è´Ÿè·æ€»åŠŸç‡',
                'emergency.backupDurationTarget': 'å¤‡ç”µæ—¶é•¿ç›®æ ‡',
                'emergency.backupDurationTargetDesc': 'æœŸæœ›çš„åº”æ€¥ä¾›ç”µæŒç»­æ—¶é—´',
                'emergency.gridFailureDetection': 'ç”µç½‘æ•…éšœæ£€æµ‹',
                'emergency.detectionEnabled': 'å·²å¯ç”¨',
                'emergency.detectionDisabled': 'å·²ç¦ç”¨',
                'emergency.gridFailureDetectionDesc': 'è‡ªåŠ¨æ£€æµ‹ç”µç½‘æ•…éšœå¹¶åˆ‡æ¢è‡³åº”æ€¥ä¾›ç”µæ¨¡å¼',
                'emergency.switchResponseTime': 'åˆ‡æ¢å“åº”æ—¶é—´',
                'emergency.switchResponseTimeDesc': 'ä»ç”µç½‘æ•…éšœåˆ°åº”æ€¥ä¾›ç”µçš„åˆ‡æ¢æ—¶é—´',
                'emergency.ultraFast': 'è¶…å¿«é€Ÿ (â‰¤10ms)',
                'emergency.fast': 'å¿«é€Ÿ (â‰¤20ms)',
                'emergency.standard': 'æ ‡å‡† (â‰¤50ms)',
                'emergency.autoChargeStrategy': 'è‡ªåŠ¨å……ç”µç­–ç•¥',
                'emergency.autoChargeStrategyDesc': 'åº”æ€¥å¤‡ç”µSOCçš„ç»´æŒç­–ç•¥',
                'emergency.alwaysCharge': 'å§‹ç»ˆä¿æŒ',
                'emergency.weatherForecast': 'å¤©æ°”é¢„è­¦',
                'emergency.scheduled': 'å®šæ—¶å……ç”µ',
                'emergency.manual': 'æ‰‹åŠ¨æ§åˆ¶',
                'emergency.loadPriorityManagement': 'è´Ÿè·ä¼˜å…ˆçº§ç®¡ç†',
                'emergency.loadPriorityDesc': 'æ ¹æ®ç”µæ± å®¹é‡è‡ªåŠ¨ç®¡ç†è´Ÿè·ä¾›ç”µä¼˜å…ˆçº§',
                'emergency.testMode': 'æµ‹è¯•æ¨¡å¼',
                
                // éœ€é‡æ§åˆ¶æ¨¡å¼
                'demand.coreSettings': 'éœ€é‡æ§åˆ¶è®¾ç½®',
                'demand.contractCapacity': 'åˆåŒå®¹é‡',
                'demand.contractCapacityDesc': 'ä¸ç”µç½‘ç­¾è®¢çš„æœ€å¤§éœ€é‡åˆåŒå®¹é‡',
                'demand.targetDemand': 'éœ€é‡ç›®æ ‡å€¼',
                'demand.targetDemandDesc': 'éœ€é‡æ§åˆ¶çš„ç›®æ ‡ä¸Šé™ï¼Œå»ºè®®è®¾ç½®ä¸ºåˆåŒå®¹é‡çš„90%',
                'demand.controlAccuracy': 'æ§åˆ¶ç²¾åº¦',
                'demand.controlAccuracyDesc': 'éœ€é‡æ§åˆ¶çš„ç²¾åº¦è¦æ±‚ï¼Œå½±å“ç”µæ± åŠ¨ä½œé¢‘ç‡',
                'demand.highAccuracy': 'é«˜ç²¾åº¦ (Â±2%)',
                'demand.mediumAccuracy': 'æ ‡å‡† (Â±5%)',
                'demand.lowAccuracy': 'å®½æ¾ (Â±10%)',
                'demand.demandPeriod': 'éœ€é‡è®¡ç®—å‘¨æœŸ',
                'demand.demandPeriodDesc': 'ç”µç½‘è®¡è´¹çš„éœ€é‡ç»Ÿè®¡å‘¨æœŸ',
                'demand.period15min': '15åˆ†é’Ÿ',
                'demand.period30min': '30åˆ†é’Ÿ',
                'demand.period60min': '60åˆ†é’Ÿ',
                'demand.predictionAlgorithm': 'è´Ÿè·é¢„æµ‹ç®—æ³•',
                'demand.predictionAlgorithmDesc': 'ç”¨äºé¢„æµ‹æœªæ¥è´Ÿè·è¶‹åŠ¿çš„ç®—æ³•',
                'demand.aiPrediction': 'AIæ™ºèƒ½é¢„æµ‹',
                'demand.historicalAverage': 'å†å²å¹³å‡',
                'demand.realtimeTracking': 'å®æ—¶è·Ÿè¸ª',
                'demand.responseSpeed': 'å“åº”é€Ÿåº¦',
                'demand.responseSpeedDesc': 'æ§åˆ¶ç­–ç•¥çš„å“åº”ç‰¹æ€§ï¼Œå½±å“ç”µæ± å¯¿å‘½',
                'demand.aggressive': 'æ¿€è¿› (å¿«é€Ÿå“åº”)',
                'demand.balanced': 'å¹³è¡¡',
                'demand.conservative': 'ä¿å®ˆ (å¹³æ»‘æ§åˆ¶)',
                'demand.overLimitHandling': 'éœ€é‡è¶…é™å¤„ç†ç­–ç•¥',
                'demand.overLimitHandlingDesc': 'å½“é¢„æµ‹éœ€é‡å°†è¶…è¿‡ç›®æ ‡å€¼æ—¶çš„å¤„ç†æªæ–½',
                'demand.emergencyDischarge': 'ç´§æ€¥æ”¾ç”µ (ç«‹å³ä»¥æœ€å¤§åŠŸç‡æ”¾ç”µ)',
                'demand.loadShedding': 'è´Ÿè·åˆ‡é™¤ (è‡ªåŠ¨åˆ‡é™¤éå…³é”®è´Ÿè·)',
                'demand.alertNotification': 'å‘Šè­¦é€šçŸ¥ (å‘é€è¶…é™é¢„è­¦)',
                'demand.realtimeMonitor': 'å®æ—¶éœ€é‡ç›‘æ§',
                'demand.exportSettings': 'å¯¼å‡ºé…ç½®',
                
                'selfConsumption.basicSettings': 'åŸºæœ¬è®¾ç½®',
                'selfConsumption.pvPriority': 'å…‰ä¼ä¼˜å…ˆçº§',
                'selfConsumption.pvFirst': 'å…‰ä¼ä¼˜å…ˆ',
                'selfConsumption.batteryFirst': 'ç”µæ± ä¼˜å…ˆ',
                'selfConsumption.balanced': 'å‡è¡¡æ¨¡å¼',
                'selfConsumption.selfConsumptionRatio': 'è‡ªå‘è‡ªç”¨æ¯”ä¾‹ç›®æ ‡',
                'selfConsumption.gridImportLimit': 'ç”µç½‘è´­ç”µé™åˆ¶',
                'selfConsumption.excessPvMode': 'ä½™ç”µå¤„ç†',
                'selfConsumption.storageFirst': 'ä¼˜å…ˆå‚¨å­˜',
                'selfConsumption.sellFirst': 'ä¼˜å…ˆä¸Šç½‘',
                'selfConsumption.noExport': 'ç¦æ­¢ä¸Šç½‘',
                'selfConsumption.socManagement': 'SOCç®¡ç†',
                'selfConsumption.chargeSocTarget': 'å……ç”µç›®æ ‡SOC',
                'selfConsumption.dischargeSocMin': 'æ”¾ç”µæœ€ä½SOC',
                'selfConsumption.socSafetyMargin': 'SOCå®‰å…¨è£•åº¦',
                'selfConsumption.adaptiveSoc': 'è‡ªé€‚åº”SOCç®¡ç†',
                'selfConsumption.powerControl': 'åŠŸç‡æ§åˆ¶',
                'selfConsumption.maxChargePower': 'æœ€å¤§å……ç”µåŠŸç‡',
                'selfConsumption.maxDischargePower': 'æœ€å¤§æ”¾ç”µåŠŸç‡',
                'selfConsumption.powerRampRate': 'åŠŸç‡çˆ¬å¡é€Ÿç‡',
                'selfConsumption.loadFollowing': 'è´Ÿè·è·Ÿè¸ª',
                'selfConsumption.timeStrategy': 'æ—¶é—´ç­–ç•¥',
                'selfConsumption.controlCycle': 'æ§åˆ¶å‘¨æœŸ',
                'selfConsumption.forecastWindow': 'é¢„æµ‹çª—å£',
                'selfConsumption.weatherForecast': 'å¤©æ°”é¢„æµ‹é›†æˆ',
                'selfConsumption.seasonalAdjust': 'å­£èŠ‚æ€§è°ƒæ•´',
                'selfConsumption.optimization': 'ä¼˜åŒ–ç›®æ ‡',
                'selfConsumption.primaryObjective': 'ä¸»è¦ç›®æ ‡',
                'selfConsumption.maxSelfConsumption': 'æœ€å¤§è‡ªå‘è‡ªç”¨',
                'selfConsumption.minGridImport': 'æœ€å°ç”µç½‘è´­ç”µ',
                'selfConsumption.batteryHealth': 'ç”µæ± å¥åº·ä¼˜å…ˆ',
                'selfConsumption.costOptimal': 'æˆæœ¬æœ€ä¼˜',
                'selfConsumption.learningAlgorithm': 'å­¦ä¹ ç®—æ³•',
                'selfConsumption.adaptiveLearning': 'è‡ªé€‚åº”å­¦ä¹ ',
                'selfConsumption.performanceTracking': 'æ€§èƒ½è·Ÿè¸ª',
                'selfConsumption.exportConfig': 'å¯¼å‡ºé…ç½®',
                
                // çŠ¶æ€
                'status.systemStatus': 'ç³»ç»ŸçŠ¶æ€',
                'status.running': 'è¿è¡Œä¸­',
                'status.currentPower': 'å½“å‰åŠŸç‡',
                'status.operationMode': 'è¿è¡Œæ¨¡å¼',
                
                // æ§åˆ¶
                'control.basicControl': 'åŸºæœ¬æ§åˆ¶',
                'control.enabled': 'å·²å¯ç”¨',
                'control.operationMode': 'è¿è¡Œæ¨¡å¼',
                'control.targetPower': 'ç›®æ ‡åŠŸç‡',
                'control.chargeDischarge': 'å……æ”¾ç”µæ§åˆ¶',
                'control.charging': 'å……ç”µ',
                'control.discharging': 'æ”¾ç”µ',
                'control.standby': 'å¾…æœº',
                'control.systemStartStop': 'ç³»ç»Ÿå¯åœ',
                'control.applySettings': 'åº”ç”¨è®¾ç½®',
                'control.reset': 'é‡ç½®',
                
                // é«˜çº§å‚æ•°
                'control.advancedParams': 'é«˜çº§å‚æ•°',
                'control.maxChargePower': 'æœ€å¤§å……ç”µåŠŸç‡',
                'control.maxDischargePower': 'æœ€å¤§æ”¾ç”µåŠŸç‡',
                'control.socUpperLimit': 'SOCä¸Šé™',
                'control.socLowerLimit': 'SOCä¸‹é™',
                'control.tempProtection': 'æ¸©åº¦ä¿æŠ¤',
                'control.overloadProtection': 'è¿‡è½½ä¿æŠ¤',
                
                // è°ƒåº¦ç­–ç•¥
                'control.scheduleStrategy': 'è°ƒåº¦ç­–ç•¥',
                'control.scheduleMode': 'è°ƒåº¦æ¨¡å¼',
                'control.responseSpeed': 'å“åº”é€Ÿåº¦',
                'control.priority': 'ä¼˜å…ˆçº§',
                'control.autoOptimize': 'è‡ªåŠ¨ä¼˜åŒ–',
                
                // è¿è¡Œæ¨¡å¼
                'mode.autoSchedule': 'è‡ªåŠ¨è°ƒåº¦',
                'mode.manualControl': 'æ‰‹åŠ¨æ§åˆ¶',
                'mode.remoteSchedule': 'è¿œç¨‹è°ƒåº¦',
                'mode.localControl': 'æœ¬åœ°æ§åˆ¶',
                
                // è°ƒåº¦æ¨¡å¼
                'schedule.peakValley': 'å³°è°·å¥—åˆ©',
                'schedule.demandResponse': 'éœ€æ±‚å“åº”',
                'schedule.ancillaryService': 'è¾…åŠ©æœåŠ¡',
                'schedule.custom': 'è‡ªå®šä¹‰ç­–ç•¥',
                
                // é€Ÿåº¦
                'speed.fast': 'å¿«é€Ÿå“åº”',
                'speed.standard': 'æ ‡å‡†å“åº”',
                'speed.slow': 'ç¼“æ…¢å“åº”',
                
                // ä¼˜å…ˆçº§
                'priority.high': 'é«˜',
                'priority.medium': 'ä¸­',
                'priority.low': 'ä½'
            },
            en: {
                // Menu
                'menu.station': 'Station',
                'menu.stationManagement': 'Station Management',
                'menu.control': 'Control',
                'menu.priceSettings': 'Price Settings',
                'menu.dataAnalysis': 'Data Analysis',
                'menu.alarmManagement': 'Alarm Management',
                'menu.deviceManagement': 'Device Management',
                'menu.userManagement': 'User Management',
                'menu.reportCenter': 'Report Center',
                'menu.systemSettings': 'System Settings',
                'menu.brandControlSystem': 'Brand Control Systems',
                'menu.sungrow': 'Sungrow',
                'menu.huawei': 'Huawei Smart',
                'menu.tesla': 'Tesla',
                
                // Page
                'page.deviceControl': 'Device Control',
                
                // Work Modes
                'control.workMode': 'Device Operation Mode',
                'control.workModeDesc': 'Select energy storage system operation mode',
                'control.selectCabinet': 'Select Storage Cabinet',
                'mode.selfConsumption': 'Self-consumption',
                'mode.selfConsumptionDesc': 'Prioritize self-generated power',
                'mode.economic': 'Economic Mode',
                'mode.economicDesc': 'Smart arbitrage optimization',
                'mode.emergency': 'Emergency Mode',
                'mode.emergencyDesc': 'Critical load protection',
                'mode.demand': 'Demand Control',
                'mode.demandDesc': 'Peak shaving optimization',
                'mode.vpp': 'VPP Mode',
                'mode.vppDesc': 'Virtual power plant aggregation',
                
                // Shared Parameters
                'shared.commonSettings': 'Common Settings',
                'shared.maxSoc': 'Maximum SOC Limit',
                'shared.maxSocDesc': 'Maximum SOC limit for battery charging in all modes',
                'shared.minSoc': 'Minimum SOC Limit',
                'shared.minSocDesc': 'Minimum SOC limit for battery discharging in all modes',
                'shared.maxChargePower': 'Maximum Charge Power',
                'shared.maxChargePowerDesc': 'System maximum charge power limit',
                'shared.maxDischargePower': 'Maximum Discharge Power',
                'shared.maxDischargePowerDesc': 'System maximum discharge power limit',
                'shared.batteryChargePower': 'Battery Charge Power',
                'shared.batteryDischargePower': 'Battery Discharge Power',
                'shared.batteryPowerDesc': 'Settable range 0-6000W',
                'shared.tempProtection': 'Temperature Protection',
                'shared.tempProtectionDesc': 'Enable battery temperature protection function',
                'shared.enabled': 'Enabled',
                'shared.disabled': 'Disabled',
                'shared.commProtocol': 'Communication Protocol',
                'shared.commProtocolDesc': 'Communication protocol with external systems',
                'shared.modbus': 'Modbus TCP',
                'shared.canbus': 'CAN Bus',
                'shared.ethercat': 'EtherCAT',
                
                // Self-consumption Mode
                'selfConsumption.coreSettings': 'Self-consumption Mode Settings',
                'selfConsumption.chargeStopSoc': 'Charge Stop SOC',
                'selfConsumption.chargeStopSocDesc': 'Battery stops charging when SOC reaches this level',
                'selfConsumption.dischargeStopSoc': 'Discharge Stop SOC',
                'selfConsumption.dischargeStopSocDesc': 'Prevent over-discharge (Higher setting allows more energy use during outage)',
                'selfConsumption.excessPvExport': 'Excess PV Export',
                'selfConsumption.exportEnabled': 'Allowed',
                'selfConsumption.exportDisabled': 'Not Allowed',
                'selfConsumption.excessPvExportDesc': 'Allow excess PV power to be exported to grid when load is satisfied and battery is full',
                'selfConsumption.socRange': 'SOC Working Range',
                'selfConsumption.socRangeInfo': 'Battery will operate within this SOC range for optimal performance and longevity',
                'selfConsumption.exportSettings': 'Save Configuration',
                
                // Economic Mode
                'economic.coreSettings': 'Economic Mode Settings',
                'economic.timePeriodTitle': 'Electricity Tariff Time Periods',
                'economic.timePeriodDesc': 'Set peak and valley electricity tariff periods. System will charge during valley periods and discharge during peak periods to maximize arbitrage profits',
                'economic.peakPeriod': 'Peak Period Settings',
                'economic.peakTime': 'Peak Period (High Tariff)',
                'economic.peakPrice': 'Peak Tariff',
                'economic.valleyPeriod': 'Valley Period Settings',
                'economic.valleyTime': 'Valley Period (Low Tariff)',
                'economic.valleyPrice': 'Valley Tariff',
                'economic.normalPeriod': 'Normal Period Settings',
                'economic.normalTime': 'Normal Period (Standard Tariff)',
                'economic.normalPrice': 'Normal Tariff',
                'economic.normalNote': 'Normal period covers all hours except peak and valley periods',
                'economic.timeRange': 'Time Range',
                'economic.addTimeSlot': '+ Add Time Slot',
                'economic.timePreview': '24-Hour Period Preview',
                'economic.peakLegend': 'Peak Period',
                'economic.valleyLegend': 'Valley Period',
                'economic.normalLegend': 'Normal Period',
                'economic.exportSettings': 'Save Configuration',
                'economic.normalPriority': 'Normal Period Priority Strategy',
                'economic.normalPriorityDesc': 'Set the charge/discharge priority strategy for normal periods',
                'economic.chargeFirst': 'Charge First',
                'economic.exportFirst': 'Export First',
                'economic.gridCharging': 'Allow Grid to Charge Battery',
                'economic.gridChargingAllowed': 'Allowed',
                'economic.gridChargingNotAllowed': 'Not Allowed',
                
                // Emergency Mode
                'emergency.backupSocReserve': 'Backup SOC Reserve',
                'emergency.backupSocReserveDesc': 'Reserve battery capacity for emergency power supply to ensure critical load safety',
                'emergency.criticalLoadPower': 'Critical Load Power',
                'emergency.criticalLoadPowerDesc': 'Total power of critical loads to be protected in emergency mode',
                'emergency.backupDurationTarget': 'Backup Duration Target',
                'emergency.backupDurationTargetDesc': 'Expected emergency power supply duration',
                'emergency.gridFailureDetection': 'Grid Failure Detection',
                'emergency.detectionEnabled': 'Enabled',
                'emergency.detectionDisabled': 'Disabled',
                'emergency.gridFailureDetectionDesc': 'Automatically detect grid failures and switch to emergency power mode',
                'emergency.switchResponseTime': 'Switch Response Time',
                'emergency.switchResponseTimeDesc': 'Time from grid failure to emergency power supply',
                'emergency.ultraFast': 'Ultra Fast (â‰¤10ms)',
                'emergency.fast': 'Fast (â‰¤20ms)',
                'emergency.standard': 'Standard (â‰¤50ms)',
                'emergency.autoChargeStrategy': 'Auto Charge Strategy',
                'emergency.autoChargeStrategyDesc': 'Strategy for maintaining emergency backup SOC',
                'emergency.alwaysCharge': 'Always Maintain',
                'emergency.weatherForecast': 'Weather Alert',
                'emergency.scheduled': 'Scheduled Charge',
                'emergency.manual': 'Manual Control',
                'emergency.loadPriorityManagement': 'Load Priority Management',
                'emergency.loadPriorityDesc': 'Automatically manage load power priority based on battery capacity',
                'emergency.testMode': 'Test Mode',
                
                // Demand Control Mode
                'demand.coreSettings': 'Demand Control Settings',
                'demand.contractCapacity': 'Contract Capacity',
                'demand.contractCapacityDesc': 'Maximum demand contract capacity with the grid',
                'demand.targetDemand': 'Target Demand',
                'demand.targetDemandDesc': 'Target upper limit for demand control, recommended at 90% of contract capacity',
                'demand.controlAccuracy': 'Control Accuracy',
                'demand.controlAccuracyDesc': 'Demand control accuracy requirement, affects battery action frequency',
                'demand.highAccuracy': 'High Accuracy (Â±2%)',
                'demand.mediumAccuracy': 'Standard (Â±5%)',
                'demand.lowAccuracy': 'Relaxed (Â±10%)',
                'demand.demandPeriod': 'Demand Period',
                'demand.demandPeriodDesc': 'Grid billing demand calculation period',
                'demand.period15min': '15 minutes',
                'demand.period30min': '30 minutes',
                'demand.period60min': '60 minutes',
                'demand.predictionAlgorithm': 'Load Prediction Algorithm',
                'demand.predictionAlgorithmDesc': 'Algorithm for predicting future load trends',
                'demand.aiPrediction': 'AI Intelligent Prediction',
                'demand.historicalAverage': 'Historical Average',
                'demand.realtimeTracking': 'Real-time Tracking',
                'demand.responseSpeed': 'Response Speed',
                'demand.responseSpeedDesc': 'Control strategy response characteristics, affects battery life',
                'demand.aggressive': 'Aggressive (Fast Response)',
                'demand.balanced': 'Balanced',
                'demand.conservative': 'Conservative (Smooth Control)',
                'demand.overLimitHandling': 'Over-limit Handling Strategy',
                'demand.overLimitHandlingDesc': 'Actions when predicted demand will exceed target value',
                'demand.emergencyDischarge': 'Emergency Discharge (Immediate max power discharge)',
                'demand.loadShedding': 'Load Shedding (Auto-cut non-critical loads)',
                'demand.alertNotification': 'Alert Notification (Send over-limit warning)',
                'demand.realtimeMonitor': 'Real-time Demand Monitor',
                'demand.exportSettings': 'Export Configuration',
                
                'selfConsumption.basicSettings': 'Basic Settings',
                'selfConsumption.pvPriority': 'PV Priority',
                'selfConsumption.pvFirst': 'PV First',
                'selfConsumption.batteryFirst': 'Battery First',
                'selfConsumption.balanced': 'Balanced Mode',
                'selfConsumption.selfConsumptionRatio': 'Self-consumption Ratio Target',
                'selfConsumption.gridImportLimit': 'Grid Import Limit',
                'selfConsumption.excessPvMode': 'Excess PV Handling',
                'selfConsumption.storageFirst': 'Storage First',
                'selfConsumption.sellFirst': 'Grid Export First',
                'selfConsumption.noExport': 'No Grid Export',
                'selfConsumption.socManagement': 'SOC Management',
                'selfConsumption.chargeSocTarget': 'Charge Target SOC',
                'selfConsumption.dischargeSocMin': 'Minimum Discharge SOC',
                'selfConsumption.socSafetyMargin': 'SOC Safety Margin',
                'selfConsumption.adaptiveSoc': 'Adaptive SOC Management',
                'selfConsumption.powerControl': 'Power Control',
                'selfConsumption.maxChargePower': 'Max Charge Power',
                'selfConsumption.maxDischargePower': 'Max Discharge Power',
                'selfConsumption.powerRampRate': 'Power Ramp Rate',
                'selfConsumption.loadFollowing': 'Load Following',
                'selfConsumption.timeStrategy': 'Time Strategy',
                'selfConsumption.controlCycle': 'Control Cycle',
                'selfConsumption.forecastWindow': 'Forecast Window',
                'selfConsumption.weatherForecast': 'Weather Forecast Integration',
                'selfConsumption.seasonalAdjust': 'Seasonal Adjustment',
                'selfConsumption.optimization': 'Optimization Targets',
                'selfConsumption.primaryObjective': 'Primary Objective',
                'selfConsumption.maxSelfConsumption': 'Maximize Self-consumption',
                'selfConsumption.minGridImport': 'Minimize Grid Import',
                'selfConsumption.batteryHealth': 'Battery Health Priority',
                'selfConsumption.costOptimal': 'Cost Optimal',
                'selfConsumption.learningAlgorithm': 'Learning Algorithm',
                'selfConsumption.adaptiveLearning': 'Adaptive Learning',
                'selfConsumption.performanceTracking': 'Performance Tracking',
                'selfConsumption.exportConfig': 'Export Configuration',
                
                // Status
                'status.systemStatus': 'System Status',
                'status.running': 'Running',
                'status.currentPower': 'Current Power',
                'status.operationMode': 'Operation Mode',
                
                // Control
                'control.basicControl': 'Basic Control',
                'control.enabled': 'Enabled',
                'control.operationMode': 'Operation Mode',
                'control.targetPower': 'Target Power',
                'control.chargeDischarge': 'Charge/Discharge Control',
                'control.charging': 'Charging',
                'control.discharging': 'Discharging',
                'control.standby': 'Standby',
                'control.systemStartStop': 'System Start/Stop',
                'control.applySettings': 'Apply Settings',
                'control.reset': 'Reset',
                
                // Advanced Parameters
                'control.advancedParams': 'Advanced Parameters',
                'control.maxChargePower': 'Max Charge Power',
                'control.maxDischargePower': 'Max Discharge Power',
                'control.socUpperLimit': 'SOC Upper Limit',
                'control.socLowerLimit': 'SOC Lower Limit',
                'control.tempProtection': 'Temperature Protection',
                'control.overloadProtection': 'Overload Protection',
                
                // Schedule Strategy
                'control.scheduleStrategy': 'Schedule Strategy',
                'control.scheduleMode': 'Schedule Mode',
                'control.responseSpeed': 'Response Speed',
                'control.priority': 'Priority',
                'control.autoOptimize': 'Auto Optimize',
                
                // Operation Modes
                'mode.autoSchedule': 'Auto Schedule',
                'mode.manualControl': 'Manual Control',
                'mode.remoteSchedule': 'Remote Schedule',
                'mode.localControl': 'Local Control',
                
                // Schedule Modes
                'schedule.peakValley': 'Peak-Valley Arbitrage',
                'schedule.demandResponse': 'Demand Response',
                'schedule.ancillaryService': 'Ancillary Service',
                'schedule.custom': 'Custom Strategy',
                
                // Speed
                'speed.fast': 'Fast Response',
                'speed.standard': 'Standard Response',
                'speed.slow': 'Slow Response',
                
                // Priority
                'priority.high': 'High',
                'priority.medium': 'Medium',
                'priority.low': 'Low'
            }
        };

        // æ›´æ–°è¯­è¨€å‡½æ•°
        function updateLanguage() {
            const lang = localStorage.getItem('language') || 'zh';
            const elements = document.querySelectorAll('[data-lang]');
            
            // æ›´æ–°HTML langå±æ€§
            document.documentElement.lang = lang === 'zh' ? 'zh-CN' : 'en';
            document.body.setAttribute('lang', lang);
            
            // æ›´æ–°é¡µé¢æ ‡é¢˜
            document.title = lang === 'zh' ? 'æ§åˆ¶ - å·¥å•†å‚¨èƒ½ç®¡ç†ç³»ç»Ÿ' : 'Control - C&I Energy Storage System';
            
            elements.forEach(element => {
                const key = element.getAttribute('data-lang');
                if (translations[lang] && translations[lang][key]) {
                    if (element.tagName === 'SELECT') {
                        // å¯¹äºä¸‹æ‹‰æ¡†ï¼Œåªæ›´æ–°å½“å‰é€‰ä¸­çš„æ˜¾ç¤º
                        const selectedIndex = element.selectedIndex;
                        element.querySelectorAll('option').forEach((option, index) => {
                            const optionKey = option.getAttribute('data-lang');
                            if (optionKey && translations[lang][optionKey]) {
                                option.textContent = translations[lang][optionKey];
                            }
                        });
                        element.selectedIndex = selectedIndex;
                    } else {
                        element.textContent = translations[lang][key];
                    }
                }
            });
        }

        // é¡µé¢åŠ è½½æ—¶æ›´æ–°è¯­è¨€
        document.addEventListener('DOMContentLoaded', updateLanguage);
        
        // ä¿®æ”¹è¯­è¨€åˆ‡æ¢æŒ‰é’®çš„è¡Œä¸º
        const originalToggleLanguage = window.toggleLanguage;
        window.toggleLanguage = function() {
            originalToggleLanguage();
            updateLanguage();
        };
        
        // å·¥ä½œæ¨¡å¼é€‰æ‹©
        let currentWorkMode = 'self-consumption';
        let vppModeEnabled = false; // VPPæ¨¡å¼æ˜¯å¦ç”±ä¸Šå±‚å¯ç”¨
        let editModes = {
            'self-consumption': false,
            'economic': false,
            'emergency': false
        };
        let sharedEditMode = false;
        let hasUnsavedChanges = false;
        let hasUnsavedSharedChanges = false;
        
        function selectWorkMode(element, mode) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯VPPæ¨¡å¼
            if (mode === 'vpp' && !vppModeEnabled) {
                alert('VPPæ¨¡å¼éœ€è¦ç”±ä¸Šå±‚ç³»ç»Ÿå¼€å¯');
                return;
            }
            
            // å¦‚æœå½“å‰æ˜¯VPPæ¨¡å¼ä¸”åœ¨è°ƒåº¦ä¸­ï¼Œä¸å…è®¸åˆ‡æ¢åˆ°å…¶ä»–æ¨¡å¼
            if (currentWorkMode === 'vpp' && vppModeEnabled) {
                alert('VPPæ¨¡å¼è°ƒåº¦ä¸­ï¼Œæ— æ³•åˆ‡æ¢åˆ°å…¶ä»–æ¨¡å¼');
                return;
            }
            
            // ç§»é™¤æ‰€æœ‰å¡ç‰‡çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.mode-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // æ¿€æ´»é€‰ä¸­çš„å¡ç‰‡
            element.classList.add('active');
            
            currentWorkMode = mode;
            console.log('åˆ‡æ¢åˆ°å·¥ä½œæ¨¡å¼:', mode);
            
            // åˆ‡æ¢åˆ°å¯¹åº”çš„tab
            if (mode !== 'vpp') {
                switchModeTab(mode);
            }
        }
        
        // æ¨¡æ‹Ÿä¸Šå±‚ç³»ç»Ÿå¯ç”¨VPPæ¨¡å¼
        function enableVPPMode(enabled) {
            vppModeEnabled = enabled;
            const vppCard = document.getElementById('vpp-mode-card');
            
            if (enabled) {
                vppCard.classList.remove('vpp-disabled');
                vppCard.classList.add('vpp-active');
                vppCard.querySelector('.mode-desc').textContent = 'è°ƒåº¦ä¸­';
                
                // è‡ªåŠ¨åˆ‡æ¢åˆ°VPPæ¨¡å¼
                selectWorkMode(vppCard, 'vpp');
            } else {
                vppCard.classList.add('vpp-disabled');
                vppCard.classList.remove('vpp-active');
                const lang = localStorage.getItem('language') || 'zh';
                vppCard.querySelector('.mode-desc').textContent = translations[lang]['mode.vppDesc'] || 'è™šæ‹Ÿç”µå‚èšåˆ';
                
                // å¦‚æœå½“å‰æ˜¯VPPæ¨¡å¼ï¼Œåˆ‡æ¢åˆ°è‡ªå‘è‡ªç”¨æ¨¡å¼
                if (currentWorkMode === 'vpp') {
                    const firstCard = document.querySelector('.mode-card:first-child');
                    selectWorkMode(firstCard, 'self-consumption');
                }
            }
        }
        
        function scrollToModeSettings(mode) {
            // æ»šåŠ¨åˆ°å¯¹åº”æ¨¡å¼çš„è®¾ç½®åŒºåŸŸ
            const settingsId = mode + '-settings';
            const settingsElement = document.getElementById(settingsId);
            if (settingsElement) {
                settingsElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                // æ·»åŠ é«˜äº®æ•ˆæœ
                settingsElement.style.transition = 'all 0.3s ease';
                settingsElement.style.boxShadow = '0 0 20px rgba(59, 130, 246, 0.3)';
                settingsElement.style.borderRadius = '8px';
                
                // 3ç§’åç§»é™¤é«˜äº®æ•ˆæœ
                setTimeout(() => {
                    settingsElement.style.boxShadow = 'none';
                }, 3000);
            }
        }
        
        function updateUIForMode(mode) {
            // æ ¹æ®ä¸åŒçš„å·¥ä½œæ¨¡å¼ï¼Œå¯ä»¥æ›´æ–°é¡µé¢ä¸Šçš„å…¶ä»–å…ƒç´ 
            const modeDescriptions = {
                'self-consumption': 'ç³»ç»Ÿå°†ä¼˜å…ˆä½¿ç”¨è‡ªå‘ç”µåŠ›ï¼Œå‡å°‘ç”µç½‘ç”¨ç”µï¼Œå®ç°èƒ½æºè‡ªç»™è‡ªè¶³',
                'economic': 'ç³»ç»Ÿå°†æ ¹æ®ç”µä»·å’Œå¸‚åœºä¿¡å·è¿›è¡Œæ™ºèƒ½å……æ”¾ç”µï¼Œå®ç°ç»æµæ•ˆç›Šæœ€å¤§åŒ–',
                'emergency': 'ç³»ç»Ÿå°†ä¿æŒé«˜ç”µé‡çŠ¶æ€ï¼Œä¸ºå…³é”®è´Ÿè·æä¾›å¯é çš„åº”æ€¥ä¾›ç”µä¿éšœ',
                'vpp': 'ç³»ç»Ÿå°†å‚ä¸è™šæ‹Ÿç”µå‚èšåˆè°ƒåº¦ï¼Œä¸å…¶ä»–åˆ†å¸ƒå¼èƒ½æºååŒä¼˜åŒ–è¿è¡Œ'
            };
            
            // å¯ä»¥æ›´æ–°çŠ¶æ€æ˜¾ç¤ºç­‰
            console.log('å½“å‰æ¨¡å¼è¯´æ˜:', modeDescriptions[mode]);
        }
        
        // è‡ªå‘è‡ªç”¨æ¨¡å¼ä¸“ç”¨åŠŸèƒ½
        function updateSocRange() {
            const chargeStopInput = document.getElementById('charge-stop-soc');
            const dischargeStopInput = document.getElementById('discharge-stop-soc');
            
            if (!chargeStopInput || !dischargeStopInput) return;
            
            const chargeStopSoc = chargeStopInput.value;
            const dischargeStopSoc = dischargeStopInput.value;
            
            const socRange = document.getElementById('soc-working-range');
            const socMinLabel = document.getElementById('soc-min-label');
            const socMaxLabel = document.getElementById('soc-max-label');
            
            if (socRange && socMinLabel && socMaxLabel) {
                // è®¡ç®—SOCèŒƒå›´çš„ä½ç½®å’Œå®½åº¦
                const minSoc = parseInt(dischargeStopSoc);
                const maxSoc = parseInt(chargeStopSoc);
                const rangeWidth = maxSoc - minSoc;
                
                // æ›´æ–°SOCèŒƒå›´æ¡çš„æ ·å¼
                socRange.style.left = `${minSoc}%`;
                socRange.style.width = `${rangeWidth}%`;
                
                // æ›´æ–°æ ‡ç­¾
                socMinLabel.textContent = `${minSoc}%`;
                socMaxLabel.textContent = `${maxSoc}%`;
                
                // éªŒè¯SOCèŒƒå›´çš„åˆç†æ€§
                if (maxSoc <= minSoc) {
                    socRange.style.background = '#ef4444';
                    console.warn('å……ç”µåœæ­¢SOCå¿…é¡»å¤§äºæ”¾ç”µåœæ­¢SOC');
                } else {
                    socRange.style.background = 'linear-gradient(90deg, #22c55e 0%, #3b82f6 50%, #f59e0b 100%)';
                }
            }
        }
        
        function updateExportStatus() {
            const exportCheckbox = document.getElementById('excess-pv-export-shared');
            if (!exportCheckbox) return;
            
            const statusText = exportCheckbox.closest('.control-item').querySelector('.control-status');
            
            if (statusText) {
                const lang = localStorage.getItem('language') || 'zh';
                if (exportCheckbox.checked) {
                    statusText.textContent = translations[lang]['selfConsumption.exportEnabled'] || 'å…è®¸';
                    statusText.style.color = '#3b82f6';
                } else {
                    statusText.textContent = translations[lang]['selfConsumption.exportDisabled'] || 'ä¸å…è®¸';
                    statusText.style.color = '#94a3b8';
                }
            }
        }
        
        // æ›´æ–°æ»‘å—å€¼æ˜¾ç¤ºå’Œå¡«å……æ•ˆæœ
        function updateSliderValue(slider, valueId) {
            const valueElement = document.getElementById(valueId);
            valueElement.value = slider.value;
            updateSliderFill(slider);
        }
        
        // æ›´æ–°æ»‘å—å¡«å……æ•ˆæœ
        function updateSliderFill(slider) {
            const value = parseInt(slider.value);
            const min = parseInt(slider.min);
            const max = parseInt(slider.max);
            const percentage = ((value - min) / (max - min)) * 100;
            
            if (slider.id === 'charge-stop-soc-slider') {
                // å……ç”µæ»‘å—ï¼š0åˆ°æ»‘å—ä½ç½®å¡«å……è“è‰²
                slider.style.setProperty('--fill-color', '#3b82f6');
                slider.style.setProperty('--fill-width', percentage + '%');
            } else if (slider.id === 'discharge-stop-soc-slider') {
                // æ”¾ç”µæ»‘å—ï¼šä»æ»‘å—ä½ç½®åˆ°100%å¡«å……è“è‰²
                slider.style.setProperty('--fill-color', '#3b82f6');
                slider.style.setProperty('--fill-width', (100 - percentage) + '%');
                // è°ƒæ•´å¡«å……ä½ç½®ä»å³ä¾§å¼€å§‹
                slider.style.setProperty('--fill-position', percentage + '%');
            }
        }
        
        // ä»è¾“å…¥æ¡†æ›´æ–°æ»‘å—
        function updateSliderFromInput(input, sliderId) {
            const slider = document.getElementById(sliderId);
            const value = parseInt(input.value);
            const min = parseInt(input.min);
            const max = parseInt(input.max);
            
            // éªŒè¯è¾“å…¥å€¼èŒƒå›´
            if (value >= min && value <= max) {
                slider.value = value;
                updateSliderFill(slider);
            } else {
                // å¦‚æœè¶…å‡ºèŒƒå›´ï¼Œæ¢å¤åˆ°æ»‘å—å½“å‰å€¼
                input.value = slider.value;
            }
        }
        
        function applySettings() {
            const chargeStopSoc = document.getElementById('charge-stop-soc-slider').value;
            const dischargeStopSoc = document.getElementById('discharge-stop-soc-slider').value;
            const excessPvExport = document.getElementById('excess-pv-export-shared').checked;
            
            // éªŒè¯å‚æ•°
            if (parseInt(chargeStopSoc) <= parseInt(dischargeStopSoc)) {
                alert('å……ç”µåœæ­¢SOCå¿…é¡»å¤§äºæ”¾ç”µåœæ­¢SOC');
                return;
            }
            
            const settings = {
                mode: 'self-consumption',
                chargeStopSoc: parseInt(chargeStopSoc),
                dischargeStopSoc: parseInt(dischargeStopSoc),
                excessPvExport: excessPvExport,
                timestamp: new Date().toISOString()
            };
            
            console.log('åº”ç”¨è‡ªå‘è‡ªç”¨æ¨¡å¼è®¾ç½®:', settings);
            
            // è¿™é‡Œå¯ä»¥å‘é€åˆ°åç«¯API
            // fetch('/api/control/settings', { method: 'POST', body: JSON.stringify(settings) });
            
            alert('è®¾ç½®å·²åº”ç”¨');
        }
        
        function resetSettings() {
            document.getElementById('charge-stop-soc').value = 95;
            document.getElementById('discharge-stop-soc').value = 20;
            document.getElementById('excess-pv-export').checked = true;
            
            updateSocRange();
            updateExportStatus();
            
            console.log('è®¾ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼');
        }
        
        function exportSettings() {
            const settings = {
                mode: 'self-consumption',
                chargeStopSoc: document.getElementById('charge-stop-soc').value,
                dischargeStopSoc: document.getElementById('discharge-stop-soc').value,
                excessPvExport: document.getElementById('excess-pv-export').checked,
                exportTime: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(settings, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'self-consumption-settings.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log('é…ç½®å·²å¯¼å‡º');
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            const chargeStopInput = document.getElementById('charge-stop-soc');
            const dischargeStopInput = document.getElementById('discharge-stop-soc');
            const exportCheckbox = document.getElementById('excess-pv-export-shared');
            
            if (chargeStopInput) {
                chargeStopInput.addEventListener('input', updateSocRange);
            }
            if (dischargeStopInput) {
                dischargeStopInput.addEventListener('input', updateSocRange);
            }
            if (exportCheckbox) {
                exportCheckbox.addEventListener('change', updateExportStatus);
            }
            
            // åˆå§‹åŒ–æ˜¾ç¤º
            updateSocRange();
            updateExportStatus();
            updateTimelinePreview();
            
            // ç»æµæ¨¡å¼çš„åˆå§‹åŒ–å°†åœ¨åˆ‡æ¢åˆ°è¯¥tabæ—¶è¿›è¡Œ
            
            // ç»‘å®šåº”æ€¥æ¨¡å¼äº‹ä»¶
            const gridDetectionCheckbox = document.getElementById('grid-failure-detection');
            if (gridDetectionCheckbox) {
                gridDetectionCheckbox.addEventListener('change', updateGridDetectionStatus);
                updateGridDetectionStatus(); // åˆå§‹åŒ–çŠ¶æ€
            }
        });
        
        // ç»æµæ¨¡å¼ä¸“ç”¨åŠŸèƒ½
        let currentPeriodType = null; // å½“å‰é€‰ä¸­çš„æ—¶æ®µç±»å‹
        let hourData = new Array(24).fill(''); // å­˜å‚¨æ¯ä¸ªå°æ—¶çš„æ—¶æ®µç±»å‹
        let isDragging = false;
        let dragStartHour = null;
        let selectedPeriodType = null;
        
        // æ—¶æ®µç±»å‹æ ‡ç­¾
        const periodTypeLabels = {
            'peak': 'å³°',
            'valley': 'è°·',
            'normal': 'å¹³'
        };
        
        // åˆå§‹åŒ–24å°æ—¶é€‰æ‹©å™¨
        function initHourSelector() {
            const hourSelector = document.getElementById('hour-selector');
            if (!hourSelector) return;
            
            // æ¸…ç©ºç°æœ‰å†…å®¹ï¼Œé¿å…é‡å¤
            hourSelector.innerHTML = '';
            
            // æ—¶é—´åˆ»åº¦å·²ç§»é™¤
            
            // æ·»åŠ ç¬¬ä¸€è¡Œï¼šæ—¶æ®µæ ‡ç­¾
            const label = document.createElement('div');
            label.className = 'hour-label';
            label.textContent = 'æ—¶æ®µ';
            hourSelector.appendChild(label);
            
            // ç”Ÿæˆ24ä¸ªå°æ—¶æ ¼å­
            for (let hour = 0; hour < 24; hour++) {
                const cell = document.createElement('div');
                cell.className = 'hour-cell';
                cell.dataset.hour = hour;
                
                // æ·»åŠ å°æ—¶æ•°å­—
                const hourNumber = document.createElement('div');
                hourNumber.className = 'hour-number';
                hourNumber.textContent = hour.toString();
                cell.appendChild(hourNumber);
                
                // æ·»åŠ æ—¶æ®µæ–‡å­—ï¼ˆåˆå§‹ä¸ºç©ºï¼‰
                const periodText = document.createElement('div');
                periodText.className = 'period-text';
                cell.appendChild(periodText);
                
                hourSelector.appendChild(cell);
                
                // é¼ æ ‡äº‹ä»¶å¤„ç†
                cell.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    isDragging = true;
                    dragStartHour = hour;
                    selectedPeriodType = currentPeriodType;
                    
                    // åº”ç”¨å½“å‰æ—¶æ®µç±»å‹åˆ°èµ·å§‹æ ¼å­
                    setHourPeriod(hour, currentPeriodType);
                });
                
                cell.addEventListener('mouseenter', () => {
                    if (isDragging && dragStartHour !== null) {
                        // è®¡ç®—æ‹–åŠ¨èŒƒå›´
                        const start = Math.min(dragStartHour, hour);
                        const end = Math.max(dragStartHour, hour);
                        
                        // æ¸…é™¤æ‰€æœ‰ä¸´æ—¶é«˜äº®
                        document.querySelectorAll('.hour-cell').forEach(c => {
                            c.classList.remove('temp-highlight');
                        });
                        
                        // åº”ç”¨åˆ°æ‹–åŠ¨èŒƒå›´å†…çš„æ‰€æœ‰æ ¼å­
                        for (let h = start; h <= end; h++) {
                            setHourPeriod(h, selectedPeriodType);
                        }
                    }
                });
                
                cell.addEventListener('click', (e) => {
                    if (!isDragging) {
                        // å•å‡»åˆ‡æ¢
                        toggleHour(hour);
                    }
                });
            }
            
            // æ·»åŠ å°æ—¶æ ‡ç­¾è¡Œ
            const hourLabelsContainer = document.querySelector('#economic-panel .hour-labels');
            if (hourLabelsContainer) {
                hourLabelsContainer.innerHTML = '<div></div>'; // ç©ºå ä½
                for (let hour = 0; hour < 24; hour++) {
                    const label = document.createElement('div');
                    label.textContent = `${hour}:00`;
                    label.style.fontSize = '12px';
                    label.style.color = '#666';
                    label.style.textAlign = 'center';
                    hourLabelsContainer.appendChild(label);
                }
            }
            
            // å…¨å±€é¼ æ ‡äº‹ä»¶
            document.addEventListener('mouseup', () => {
                isDragging = false;
                dragStartHour = null;
                selectedPeriodType = null;
            });
            
            // é˜²æ­¢æ–‡æœ¬é€‰æ‹©
            hourSelector.addEventListener('selectstart', (e) => {
                e.preventDefault();
            });
        }
        
        // è®¾ç½®å°æ—¶çš„æ—¶æ®µç±»å‹
        function setHourPeriod(hour, periodType) {
            const cell = document.querySelector(`[data-hour="${hour}"]`);
            if (!cell) return;
            
            hourData[hour] = periodType;
            
            // æ¸…é™¤åŸæœ‰ç±»å¹¶åº”ç”¨æ–°ç±»
            cell.classList.remove('peak', 'valley', 'normal');
            if (periodType) {
                cell.classList.add(periodType);
                cell.querySelector('.period-text').textContent = periodTypeLabels[periodType] || '';
            } else {
                cell.querySelector('.period-text').textContent = '';
            }
            
            updatePeriodStatistics();
        }
        
        // é€‰æ‹©æ—¶æ®µç±»å‹
        function selectPeriodType(type) {
            currentPeriodType = type;
            
            // æ›´æ–°å›¾ä¾‹çŠ¶æ€
            document.querySelectorAll('.legend-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeItem = document.querySelector(`.legend-item.${type}-legend`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
        }
        
        // åˆ‡æ¢å°æ—¶çš„æ—¶æ®µç±»å‹ï¼ˆå•å‡»ï¼‰
        function toggleHour(hour) {
            const cell = document.querySelector(`[data-hour="${hour}"]`);
            if (!cell) return;
            
            // å¦‚æœç‚¹å‡»çš„æ˜¯ç›¸åŒç±»å‹ï¼Œåˆ™æ¸…é™¤
            if (hourData[hour] === currentPeriodType) {
                hourData[hour] = '';
                cell.className = 'hour-cell';
                cell.querySelector('.period-text').textContent = '';
            } else {
                // è®¾ç½®æ–°çš„æ—¶æ®µç±»å‹
                setHourPeriod(hour, currentPeriodType);
            }
        }
        
        // æ¸…é™¤æ‰€æœ‰æ—¶æ®µ
        function clearAllHours() {
            hourData.fill('');
            document.querySelectorAll('.hour-cell').forEach(cell => {
                cell.className = 'hour-cell';
                const periodText = cell.querySelector('.period-text');
                if (periodText) {
                    periodText.textContent = '';
                }
            });
            updatePeriodStatistics();
        }
        
        // åŠ è½½é¢„è®¾é…ç½®
        function loadPreset(presetType) {
            clearAllHours();
            
            if (presetType === 'commercial') {
                // å·¥å•†ä¸šé¢„è®¾ï¼šå³°æ—¶æ®µ 8-11, 18-22ï¼›è°·æ—¶æ®µ 23-7
                for (let h = 8; h <= 11; h++) hourData[h] = 'peak';
                for (let h = 18; h <= 22; h++) hourData[h] = 'peak';
                for (let h = 23; h <= 23; h++) hourData[h] = 'valley';
                for (let h = 0; h <= 7; h++) hourData[h] = 'valley';
                // å…¶ä½™ä¸ºå¹³æ—¶æ®µ
                for (let h = 0; h < 24; h++) {
                    if (!hourData[h]) hourData[h] = 'normal';
                }
            } else if (presetType === 'industrial') {
                // å·¥ä¸šé¢„è®¾ï¼šå³°æ—¶æ®µ 9-12, 17-21ï¼›è°·æ—¶æ®µ 0-6
                for (let h = 9; h <= 12; h++) hourData[h] = 'peak';
                for (let h = 17; h <= 21; h++) hourData[h] = 'peak';
                for (let h = 0; h <= 6; h++) hourData[h] = 'valley';
                // å…¶ä½™ä¸ºå¹³æ—¶æ®µ
                for (let h = 0; h < 24; h++) {
                    if (!hourData[h]) hourData[h] = 'normal';
                }
            }
            
            // æ›´æ–°æ˜¾ç¤º
            hourData.forEach((type, hour) => {
                const cell = document.querySelector(`[data-hour="${hour}"]`);
                if (cell && type) {
                    cell.className = `hour-cell ${type}`;
                    const periodTexts = {
                        'peak': 'å³°',
                        'valley': 'è°·',
                        'normal': 'å¹³'
                    };
                    cell.querySelector('.period-text').textContent = periodTexts[type] || '';
                }
            });
            
            updatePeriodStatistics();
        }
        
        // æ›´æ–°æ—¶æ®µç»Ÿè®¡
        function updatePeriodStatistics() {
            const stats = {
                peak: 0,
                valley: 0,
                normal: 0
            };
            
            hourData.forEach(type => {
                if (type && stats.hasOwnProperty(type)) {
                    stats[type]++;
                }
            });
            
            // ç»Ÿè®¡å·²æ›´æ–°ï¼Œå¯ç”¨äºå…¶ä»–ç”¨é€”
            console.log('æ—¶æ®µç»Ÿè®¡:', stats);
        }
        
        let timeSlotCounter = { peak: 2, valley: 1 };
        
        function addTimeSlot(periodType) {
            const container = document.getElementById(`${periodType}-time-slots`);
            const slotNumber = ++timeSlotCounter[periodType];
            
            const timeSlot = document.createElement('div');
            timeSlot.className = 'time-slot';
            timeSlot.innerHTML = `
                <label data-lang="economic.timeRange">æ—¶é—´æ®µ${slotNumber}:</label>
                <input type="time" class="time-input" value="00:00" id="${periodType}-start-${slotNumber}">
                <span>-</span>
                <input type="time" class="time-input" value="00:00" id="${periodType}-end-${slotNumber}">
                <button class="btn-remove" onclick="removeTimeSlot(this)" title="åˆ é™¤æ—¶æ®µ">Ã—</button>
            `;
            
            container.appendChild(timeSlot);
            
            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            const startInput = timeSlot.querySelector(`#${periodType}-start-${slotNumber}`);
            const endInput = timeSlot.querySelector(`#${periodType}-end-${slotNumber}`);
            startInput.addEventListener('change', updateTimelinePreview);
            endInput.addEventListener('change', updateTimelinePreview);
            
            updateTimelinePreview();
        }
        
        function removeTimeSlot(button) {
            const timeSlot = button.parentElement;
            const container = timeSlot.parentElement;
            
            // æ£€æŸ¥æ˜¯å¦è‡³å°‘ä¿ç•™ä¸€ä¸ªæ—¶æ®µï¼ˆå¯¹äºå³°è°·æ—¶æ®µï¼‰
            const remainingSlots = container.querySelectorAll('.time-slot').length;
            if (remainingSlots <= 1 && (container.id === 'peak-time-slots' || container.id === 'valley-time-slots')) {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªæ—¶æ®µ');
                return;
            }
            
            timeSlot.remove();
            updateTimelinePreview();
        }
        
        function updateTimelinePreview() {
            const timeline = document.getElementById('time-timeline');
            if (!timeline) return;
            
            timeline.innerHTML = '';
            
            // åˆ›å»º24å°æ—¶æ—¶é—´è½´
            for (let hour = 0; hour < 24; hour++) {
                const hourElement = document.createElement('div');
                hourElement.className = 'timeline-hour';
                hourElement.style.flex = '1';
                hourElement.textContent = hour.toString().padStart(2, '0');
                
                // åˆ¤æ–­æ—¶æ®µç±»å‹
                const periodType = getHourPeriodType(hour);
                hourElement.classList.add(periodType);
                
                timeline.appendChild(hourElement);
            }
        }
        
        function getHourPeriodType(hour) {
            // æ£€æŸ¥å³°æ—¶æ®µ
            if (isHourInPeriod(hour, 'peak')) {
                return 'peak';
            }
            
            // æ£€æŸ¥è°·æ—¶æ®µ
            if (isHourInPeriod(hour, 'valley')) {
                return 'valley';
            }
            
            // é»˜è®¤ä¸ºå¹³æ—¶æ®µ
            return 'normal';
        }
        
        function isHourInPeriod(hour, periodType) {
            const slots = document.querySelectorAll(`#${periodType}-time-slots .time-slot`);
            
            for (const slot of slots) {
                const startInput = slot.querySelector('.time-input:first-of-type');
                const endInput = slot.querySelector('.time-input:last-of-type');
                
                if (!startInput || !endInput || !startInput.value || !endInput.value) continue;
                
                const startHour = parseInt(startInput.value.split(':')[0]);
                const endHour = parseInt(endInput.value.split(':')[0]);
                
                // å¤„ç†è·¨æ—¥æœŸçš„æ—¶æ®µï¼ˆå¦‚23:00-07:00ï¼‰
                if (startHour > endHour) {
                    if (hour >= startHour || hour < endHour) {
                        return true;
                    }
                } else {
                    if (hour >= startHour && hour < endHour) {
                        return true;
                    }
                }
            }
            
            return false;
        }
        
        function applyEconomicSettings() {
            const settings = {
                mode: 'economic',
                hourlyPeriods: hourData,
                timestamp: new Date().toISOString()
            };
            
            // æ£€æŸ¥æ˜¯å¦è®¾ç½®äº†æ—¶æ®µ
            const hasAnyPeriod = hourData.some(type => type !== '');
            if (!hasAnyPeriod) {
                alert('è¯·è‡³å°‘è®¾ç½®ä¸€ä¸ªæ—¶æ®µ');
                return;
            }
            
            console.log('åº”ç”¨ç»æµæ¨¡å¼è®¾ç½®:', settings);
            
            // è¿™é‡Œå¯ä»¥å‘é€åˆ°åç«¯API
            // fetch('/api/control/economic-settings', { method: 'POST', body: JSON.stringify(settings) });
            
            alert('ç»æµæ¨¡å¼è®¾ç½®å·²åº”ç”¨');
        }
        
        function getTimePeriods(periodType) {
            const slots = document.querySelectorAll(`#${periodType}-time-slots .time-slot`);
            const periods = [];
            
            slots.forEach(slot => {
                const startInput = slot.querySelector('.time-input:first-of-type');
                const endInput = slot.querySelector('.time-input:last-of-type');
                
                if (startInput && endInput && startInput.value && endInput.value) {
                    periods.push({
                        start: startInput.value,
                        end: endInput.value
                    });
                }
            });
            
            return periods;
        }
        
        function hasTimeOverlap(periods1, periods2) {
            for (const p1 of periods1) {
                for (const p2 of periods2) {
                    if (isTimeOverlap(p1, p2)) {
                        return true;
                    }
                }
            }
            return false;
        }
        
        function isTimeOverlap(period1, period2) {
            const start1 = timeToMinutes(period1.start);
            const end1 = timeToMinutes(period1.end);
            const start2 = timeToMinutes(period2.start);
            const end2 = timeToMinutes(period2.end);
            
            // å¤„ç†è·¨æ—¥çš„æƒ…å†µ
            const end1Adjusted = end1 < start1 ? end1 + 24 * 60 : end1;
            const end2Adjusted = end2 < start2 ? end2 + 24 * 60 : end2;
            
            return !(end1Adjusted <= start2 || end2Adjusted <= start1);
        }
        
        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }
        
        function resetEconomicSettings() {
            // é‡ç½®æ—¶æ®µä¸ºé»˜è®¤å·¥å•†ä¸šé…ç½®
            loadPreset('commercial');
            
            console.log('ç»æµæ¨¡å¼è®¾ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼');
        }
        
        function resetTimePeriods(periodType, periods) {
            const container = document.getElementById(`${periodType}-time-slots`);
            container.innerHTML = '';
            
            periods.forEach((period, index) => {
                const slotNumber = index + 1;
                const timeSlot = document.createElement('div');
                timeSlot.className = 'time-slot';
                timeSlot.innerHTML = `
                    <label data-lang="economic.timeRange">æ—¶é—´æ®µ${slotNumber}:</label>
                    <input type="time" class="time-input" value="${period.start}" id="${periodType}-start-${slotNumber}">
                    <span>-</span>
                    <input type="time" class="time-input" value="${period.end}" id="${periodType}-end-${slotNumber}">
                    <button class="btn-remove" onclick="removeTimeSlot(this)" title="åˆ é™¤æ—¶æ®µ">Ã—</button>
                `;
                container.appendChild(timeSlot);
                
                // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
                const startInput = timeSlot.querySelector(`#${periodType}-start-${slotNumber}`);
                const endInput = timeSlot.querySelector(`#${periodType}-end-${slotNumber}`);
                startInput.addEventListener('change', updateTimelinePreview);
                endInput.addEventListener('change', updateTimelinePreview);
            });
            
            timeSlotCounter[periodType] = periods.length;
        }
        
        function exportEconomicSettings() {
            const settings = {
                mode: 'economic',
                hourlyPeriods: hourData,
                exportTime: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(settings, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'economic-mode-settings.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log('ç»æµæ¨¡å¼é…ç½®å·²å¯¼å‡º');
        }
        
        // åº”æ€¥æ¨¡å¼åŠŸèƒ½
        function updateGridDetectionStatus() {
            const checkbox = document.getElementById('grid-failure-detection');
            if (!checkbox) return;
            
            const statusText = checkbox.closest('.control-item').querySelector('.control-status');
            
            if (statusText) {
                const lang = localStorage.getItem('language') || 'zh';
                if (checkbox.checked) {
                    statusText.textContent = translations[lang]['emergency.detectionEnabled'] || 'å·²å¯ç”¨';
                    statusText.style.color = '#22c55e';
                } else {
                    statusText.textContent = translations[lang]['emergency.detectionDisabled'] || 'å·²ç¦ç”¨';
                    statusText.style.color = '#ef4444';
                }
            }
        }
        
        function applyEmergencySettings() {
            const settings = {
                mode: 'emergency',
                backupSocReserve: document.getElementById('backup-soc-reserve').value,
                criticalLoadPower: document.getElementById('critical-load-power').value,
                backupDurationTarget: document.getElementById('backup-duration-target').value,
                gridFailureDetection: document.getElementById('grid-failure-detection').checked,
                switchResponseTime: document.getElementById('switch-response-time').value,
                autoChargeStrategy: document.getElementById('auto-charge-strategy').value,
                timestamp: new Date().toISOString()
            };
            
            console.log('åº”ç”¨åº”æ€¥æ¨¡å¼è®¾ç½®:', settings);
            
            // éªŒè¯å¤‡ç”µå®¹é‡æ˜¯å¦è¶³å¤Ÿ
            const socReserve = parseInt(settings.backupSocReserve);
            const loadPower = parseInt(settings.criticalLoadPower);
            const duration = parseInt(settings.backupDurationTarget);
            
            // å‡è®¾ç”µæ± å®¹é‡ä¸º 100kWh (å®é™…åº”ä»ç³»ç»Ÿé…ç½®è·å–)
            const batteryCapacity = 100000; // Wh
            const requiredEnergy = loadPower * duration; // Wh
            const availableEnergy = batteryCapacity * (socReserve / 100); // Wh
            
            if (requiredEnergy > availableEnergy) {
                const maxDuration = Math.floor(availableEnergy / loadPower);
                alert(`è­¦å‘Šï¼šå½“å‰å¤‡ç”µSOC (${socReserve}%) ä»…èƒ½æ”¯æ’‘ ${maxDuration} å°æ—¶ï¼Œä½äºç›®æ ‡æ—¶é•¿ ${duration} å°æ—¶`);
            }
            
            alert('åº”æ€¥æ¨¡å¼è®¾ç½®å·²åº”ç”¨');
        }
        
        function resetEmergencySettings() {
            document.getElementById('backup-soc-reserve').value = 80;
            document.getElementById('critical-load-power').value = 5000;
            document.getElementById('backup-duration-target').value = 4;
            document.getElementById('grid-failure-detection').checked = true;
            document.getElementById('switch-response-time').value = '20';
            document.getElementById('auto-charge-strategy').value = 'forecast';
            
            updateGridDetectionStatus();
            
            console.log('åº”æ€¥æ¨¡å¼è®¾ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼');
        }
        
        function testEmergencyMode() {
            if (confirm('ç¡®å®šè¦è¿›å…¥åº”æ€¥æ¨¡å¼æµ‹è¯•å—ï¼Ÿç³»ç»Ÿå°†æ¨¡æ‹Ÿç”µç½‘æ•…éšœå¹¶åˆ‡æ¢è‡³åº”æ€¥ä¾›ç”µæ¨¡å¼ã€‚')) {
                console.log('å¼€å§‹åº”æ€¥æ¨¡å¼æµ‹è¯•...');
                
                // æ¨¡æ‹Ÿæµ‹è¯•è¿‡ç¨‹
                alert('åº”æ€¥æ¨¡å¼æµ‹è¯•å¼€å§‹\n\n1. æ¨¡æ‹Ÿç”µç½‘æ•…éšœ...\n2. åˆ‡æ¢è‡³åº”æ€¥ä¾›ç”µ (20ms)\n3. å…³é”®è´Ÿè·ä¾›ç”µæ­£å¸¸\n4. é¢„è®¡å¯æŒç»­ 4.2 å°æ—¶\n\næµ‹è¯•å®Œæˆï¼');
            }
        }
        
        // éœ€é‡æ§åˆ¶æ¨¡å¼åŠŸèƒ½
        function applyDemandSettings() {
            const settings = {
                mode: 'demand',
                contractCapacity: document.getElementById('contract-capacity').value,
                targetDemand: document.getElementById('target-demand').value,
                demandPeriod: document.getElementById('demand-period').value,
                predictionAlgorithm: document.getElementById('prediction-algorithm').value,
                emergencyDischarge: document.getElementById('emergency-discharge').checked,
                loadShedding: document.getElementById('load-shedding').checked,
                alertNotification: document.getElementById('alert-notification').checked,
                timestamp: new Date().toISOString()
            };
            
            // éªŒè¯ç›®æ ‡éœ€é‡æ˜¯å¦åˆç†
            const contractCap = parseInt(settings.contractCapacity);
            const targetDemand = parseInt(settings.targetDemand);
            
            if (targetDemand > contractCap) {
                alert('è­¦å‘Šï¼šéœ€é‡ç›®æ ‡å€¼ä¸èƒ½è¶…è¿‡åˆåŒå®¹é‡ï¼');
                return;
            }
            
            if (targetDemand > contractCap * 0.95) {
                alert('æç¤ºï¼šéœ€é‡ç›®æ ‡å€¼æ¥è¿‘åˆåŒå®¹é‡ï¼Œå¯èƒ½å­˜åœ¨è¶…é™é£é™©ï¼Œå»ºè®®è®¾ç½®ä¸ºåˆåŒå®¹é‡çš„90%ä»¥ä¸‹');
            }
            
            console.log('åº”ç”¨éœ€é‡æ§åˆ¶è®¾ç½®:', settings);
            alert('éœ€é‡æ§åˆ¶è®¾ç½®å·²åº”ç”¨');
        }
        
        function resetDemandSettings() {
            const contractCap = 1000;
            document.getElementById('contract-capacity').value = contractCap;
            document.getElementById('target-demand').value = contractCap * 0.9; // 90% of contract
            document.getElementById('demand-period').value = '15';
            document.getElementById('prediction-algorithm').value = 'ai';
            document.getElementById('emergency-discharge').checked = true;
            document.getElementById('load-shedding').checked = false;
            document.getElementById('alert-notification').checked = true;
            
            console.log('éœ€é‡æ§åˆ¶è®¾ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼');
        }
        
        function exportDemandSettings() {
            const settings = {
                mode: 'demand',
                contractCapacity: document.getElementById('contract-capacity').value,
                targetDemand: document.getElementById('target-demand').value,
                demandPeriod: document.getElementById('demand-period').value,
                predictionAlgorithm: document.getElementById('prediction-algorithm').value,
                emergencyDischarge: document.getElementById('emergency-discharge').checked,
                loadShedding: document.getElementById('load-shedding').checked,
                alertNotification: document.getElementById('alert-notification').checked,
                exportTime: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(settings, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'demand-control-settings.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log('éœ€é‡æ§åˆ¶é…ç½®å·²å¯¼å‡º');
        }
        
        // Tab åˆ‡æ¢åŠŸèƒ½
        function switchModeTab(tabId, skipConfirmation = false) {
            // æ£€æŸ¥æ˜¯å¦æœ‰æœªä¿å­˜çš„æ›´æ”¹
            const currentActiveTab = document.querySelector('.tab-button.active');
            const currentTabId = currentActiveTab ? getCurrentTabId(currentActiveTab) : null;
            
            // æ£€æŸ¥å½“å‰tabçš„ç¼–è¾‘æ¨¡å¼
            if (!skipConfirmation && currentTabId && editModes[currentTabId] && hasUnsavedChanges) {
                showSaveConfirmation(() => {
                    // ä¿å­˜æ“ä½œ
                    saveCurrentTabSettings();
                    proceedWithTabSwitch(tabId);
                }, () => {
                    // å–æ¶ˆä¿å­˜ï¼Œç›´æ¥åˆ‡æ¢
                    hasUnsavedChanges = false;
                    proceedWithTabSwitch(tabId);
                });
                return;
            }
            
            // æ£€æŸ¥å…±äº«è®¾ç½®çš„ç¼–è¾‘æ¨¡å¼
            if (!skipConfirmation && sharedEditMode && hasUnsavedSharedChanges) {
                showSaveConfirmation(() => {
                    // ä¿å­˜å…±äº«è®¾ç½®
                    saveSharedEdit();
                    proceedWithTabSwitch(tabId);
                }, () => {
                    // å–æ¶ˆä¿å­˜ï¼Œç›´æ¥åˆ‡æ¢
                    hasUnsavedSharedChanges = false;
                    const editBtn = document.querySelector('.shared-edit-btn');
                    const sharedSection = document.querySelector('.shared-params-section');
                    exitSharedEditMode(editBtn, sharedSection);
                    proceedWithTabSwitch(tabId);
                });
                return;
            }
            
            proceedWithTabSwitch(tabId);
        }
        
        function proceedWithTabSwitch(tabId) {
            // é€€å‡ºå½“å‰tabçš„ç¼–è¾‘æ¨¡å¼
            const currentActiveTab = document.querySelector('.tab-button.active');
            const currentTabId = currentActiveTab ? getCurrentTabId(currentActiveTab) : null;
            
            if (currentTabId && editModes[currentTabId]) {
                // æ‰¾åˆ°å½“å‰tabçš„ç¼–è¾‘æŒ‰é’®å¹¶é€€å‡ºç¼–è¾‘æ¨¡å¼
                const currentEditBtn = currentActiveTab.querySelector('.tab-edit-btn');
                const currentPanel = document.getElementById(currentTabId + '-panel');
                if (currentEditBtn && currentPanel) {
                    exitEditMode(currentTabId, currentEditBtn, currentPanel);
                }
            }
            
            // å¦‚æœå…±äº«è®¾ç½®å¤„äºç¼–è¾‘æ¨¡å¼ï¼Œä¹Ÿé€€å‡º
            if (sharedEditMode) {
                const sharedEditBtn = document.querySelector('.shared-edit-btn');
                const sharedSection = document.querySelector('.shared-params-section');
                if (sharedEditBtn && sharedSection) {
                    hasUnsavedSharedChanges = false;
                    exitSharedEditMode(sharedEditBtn, sharedSection);
                }
            }
            
            
            // ç§»é™¤æ‰€æœ‰ tab button çš„ active çŠ¶æ€
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // éšè—æ‰€æœ‰ tab panel
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // æ¿€æ´»å¯¹åº”çš„ tab button
            const targetButton = Array.from(document.querySelectorAll('.tab-button')).find(btn => 
                btn.onclick && btn.onclick.toString().includes(`'${tabId}'`)
            );
            if (targetButton) {
                targetButton.classList.add('active');
            }
            
            // æ˜¾ç¤ºå¯¹åº”çš„ tab panel
            const panelId = tabId + '-panel';
            const panel = document.getElementById(panelId);
            if (panel) {
                panel.classList.add('active');
                
                // æ–°tabå§‹ç»ˆä»¥åªè¯»æ¨¡å¼å¼€å§‹
                panel.classList.add('readonly-mode');
                
                // å¦‚æœåˆ‡æ¢åˆ°ç»æµæ¨¡å¼ï¼Œåˆå§‹åŒ–æ—¶é—´é€‰æ‹©å™¨
                if (tabId === 'economic') {
                    setTimeout(() => {
                        initHourSelector();
                        // ä¸é»˜è®¤é€‰ä¸­ä»»ä½•æ—¶æ®µç±»å‹
                        initGridChargingSwitch(); // åˆå§‹åŒ–ç”µç½‘å……ç”µå¼€å…³
                    }, 100);
                }
            }
            
            console.log('åˆ‡æ¢åˆ°æ¨¡å¼è®¾ç½®:', tabId);
        }
        
        // è·å–å½“å‰tabçš„ID
        function getCurrentTabId(button) {
            if (!button) return null;
            const onclick = button.getAttribute('onclick');
            if (!onclick) return null;
            const match = onclick.match(/switchModeTab\('([^']+)'\)/);
            return match ? match[1] : null;
        }
        
        // åˆ‡æ¢ç¼–è¾‘æ¨¡å¼
        function toggleEditMode(tabId, event) {
            event.stopPropagation(); // é˜²æ­¢è§¦å‘tabåˆ‡æ¢
            
            const editBtn = event.target.closest('.tab-edit-btn');
            const panel = document.getElementById(tabId + '-panel');
            
            if (editModes[tabId]) {
                // é€€å‡ºç¼–è¾‘æ¨¡å¼
                const hasChanges = (tabId === 'economic') ? 
                    (hasUnsavedChanges || hasUnsavedSharedChanges) : 
                    hasUnsavedChanges;
                    
                if (hasChanges) {
                    showSaveConfirmation(() => {
                        // ä¿å­˜
                        saveCurrentTabSettings();
                        exitEditMode(tabId, editBtn, panel);
                    }, () => {
                        // ä¸ä¿å­˜
                        hasUnsavedChanges = false;
                        if (tabId === 'economic') {
                            hasUnsavedSharedChanges = false;
                        }
                        exitEditMode(tabId, editBtn, panel);
                    });
                } else {
                    exitEditMode(tabId, editBtn, panel);
                }
            } else {
                // è¿›å…¥ç¼–è¾‘æ¨¡å¼
                enterEditMode(tabId, editBtn, panel);
            }
        }
        
        function enterEditMode(tabId, editBtn, panel) {
            editModes[tabId] = true;
            editBtn.classList.add('editing');
            panel.classList.remove('readonly-mode');
            hasUnsavedChanges = false; // é‡ç½®æœªä¿å­˜çŠ¶æ€
            
            // ç›‘å¬å˜åŒ– - ä½¿ç”¨æ•è·é˜¶æ®µç¡®ä¿æ‰€æœ‰è¾“å…¥éƒ½è¢«ç›‘å¬
            panel.addEventListener('input', handleInputChange, true);
            panel.addEventListener('change', handleInputChange, true);
            panel.addEventListener('click', handleInputChange, true);
            
            // å¦‚æœæ˜¯ç»æµæ¨¡å¼ï¼ŒåŒæ—¶è¿›å…¥å…±äº«è®¾ç½®ç¼–è¾‘æ¨¡å¼å¹¶æ˜¾ç¤ºä¿å­˜æŒ‰é’®
            if (tabId === 'economic') {
                const sharedEditBtn = document.querySelector('.shared-edit-btn');
                const sharedSection = document.querySelector('.shared-params-section');
                if (sharedEditBtn && sharedSection && !sharedEditMode) {
                    enterSharedEditMode(sharedEditBtn, sharedSection);
                }
                
                // æ˜¾ç¤ºç»æµæ¨¡å¼çš„å–æ¶ˆå’Œä¿å­˜æŒ‰é’®
                const economicActions = document.querySelector('.economic-edit-actions');
                if (economicActions) {
                    economicActions.style.display = 'block';
                }
            }
        }
        
        function exitEditMode(tabId, editBtn, panel) {
            editModes[tabId] = false;
            editBtn.classList.remove('editing');
            panel.classList.add('readonly-mode');
            hasUnsavedChanges = false; // é‡ç½®æœªä¿å­˜çŠ¶æ€
            
            // ç§»é™¤ç›‘å¬
            panel.removeEventListener('input', handleInputChange, true);
            panel.removeEventListener('change', handleInputChange, true);
            panel.removeEventListener('click', handleInputChange, true);
            
            // å¦‚æœæ˜¯ç»æµæ¨¡å¼ï¼ŒåŒæ—¶é€€å‡ºå…±äº«è®¾ç½®ç¼–è¾‘æ¨¡å¼å¹¶éšè—ä¿å­˜æŒ‰é’®
            if (tabId === 'economic') {
                if (sharedEditMode) {
                    const sharedEditBtn = document.querySelector('.shared-edit-btn');
                    const sharedSection = document.querySelector('.shared-params-section');
                    if (sharedEditBtn && sharedSection) {
                        hasUnsavedSharedChanges = false;
                        exitSharedEditMode(sharedEditBtn, sharedSection);
                    }
                }
                
                // éšè—ç»æµæ¨¡å¼çš„å–æ¶ˆå’Œä¿å­˜æŒ‰é’®
                const economicActions = document.querySelector('.economic-edit-actions');
                if (economicActions) {
                    economicActions.style.display = 'none';
                }
            }
        }
        
        function handleInputChange() {
            hasUnsavedChanges = true;
        }
        
        function handleSharedInputChange() {
            hasUnsavedSharedChanges = true;
        }
        
        // æ˜¾ç¤ºä¿å­˜ç¡®è®¤å¯¹è¯æ¡†
        function showSaveConfirmation(onSave, onCancel) {
            // åˆ›å»ºé®ç½©å±‚
            const overlay = document.createElement('div');
            overlay.className = 'save-dialog-overlay';
            
            // åˆ›å»ºå¯¹è¯æ¡†
            const dialog = document.createElement('div');
            dialog.className = 'save-dialog';
            dialog.innerHTML = `
                <h3 style="margin-bottom: 1rem; color: #1e293b;">æç¤º</h3>
                <p style="margin-bottom: 1.5rem; color: #64748b;">ä½ è¿˜æ²¡æœ‰ä¿å­˜ï¼Œæ˜¯å¦ä¿å­˜ï¼Ÿ</p>
                <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="handleSaveCancel()">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="handleSaveConfirm()">ç¡®è®¤</button>
                </div>
            `;
            
            // å®šä¹‰å…¨å±€å‡½æ•°
            window.handleSaveConfirm = () => {
                document.body.removeChild(overlay);
                document.body.removeChild(dialog);
                onSave();
            };
            
            window.handleSaveCancel = () => {
                document.body.removeChild(overlay);
                document.body.removeChild(dialog);
                onCancel();
            };
            
            document.body.appendChild(overlay);
            document.body.appendChild(dialog);
        }
        
        // ä¿å­˜å½“å‰tabçš„è®¾ç½®
        function saveCurrentTabSettings() {
            const currentTab = document.querySelector('.tab-button.active');
            const tabId = getCurrentTabId(currentTab);
            
            console.log('ä¿å­˜è®¾ç½®:', tabId);
            hasUnsavedChanges = false;
            
            // å¦‚æœæ˜¯ç»æµæ¨¡å¼ï¼ŒåŒæ—¶ä¿å­˜å…±äº«è®¾ç½®
            if (tabId === 'economic' && sharedEditMode) {
                saveSharedSettings();
            }
            
            // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„ä¿å­˜é€»è¾‘
            alert('è®¾ç½®å·²ä¿å­˜');
        }
        
        // åˆ‡æ¢å…±äº«å‚æ•°ç¼–è¾‘æ¨¡å¼
        function toggleSharedEditMode(event) {
            const editBtn = event.target;
            const sharedSection = document.querySelector('.shared-params-section');
            
            // è¿›å…¥ç¼–è¾‘æ¨¡å¼
            enterSharedEditMode(editBtn, sharedSection);
        }
        
        function enterSharedEditMode(editBtn, section) {
            sharedEditMode = true;
            editBtn.style.display = 'none'; // éšè—ç¼–è¾‘æŒ‰é’®
            section.classList.remove('readonly-mode');
            hasUnsavedSharedChanges = false; // é‡ç½®å…±äº«è®¾ç½®çš„æœªä¿å­˜çŠ¶æ€
            
            // æ˜¾ç¤ºå–æ¶ˆå’Œä¿å­˜æŒ‰é’®
            const actionsDiv = document.querySelector('.shared-edit-actions');
            if (actionsDiv) {
                actionsDiv.style.display = 'block';
            }
            
            // ç›‘å¬å˜åŒ–
            section.addEventListener('input', handleSharedInputChange);
            section.addEventListener('change', handleSharedInputChange);
        }
        
        function exitSharedEditMode(editBtn, section) {
            sharedEditMode = false;
            editBtn.style.display = ''; // æ˜¾ç¤ºç¼–è¾‘æŒ‰é’®
            section.classList.add('readonly-mode');
            
            // éšè—å–æ¶ˆå’Œä¿å­˜æŒ‰é’®
            const actionsDiv = document.querySelector('.shared-edit-actions');
            if (actionsDiv) {
                actionsDiv.style.display = 'none';
            }
            
            // ç§»é™¤ç›‘å¬
            section.removeEventListener('input', handleSharedInputChange);
            section.removeEventListener('change', handleSharedInputChange);
        }
        
        function saveSharedSettings() {
            console.log('ä¿å­˜é€šç”¨è®¾ç½®');
            hasUnsavedSharedChanges = false;
            // ç›´æ¥ä¿å­˜ï¼Œä¸æ˜¾ç¤ºæç¤º
        }
        
        // å–æ¶ˆå…±äº«å‚æ•°ç¼–è¾‘
        function cancelSharedEdit() {
            const editBtn = document.querySelector('.shared-edit-btn');
            const sharedSection = document.querySelector('.shared-params-section');
            
            if (hasUnsavedSharedChanges) {
                if (confirm('æ‚¨æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦å–æ¶ˆå—ï¼Ÿ')) {
                    hasUnsavedSharedChanges = false;
                    exitSharedEditMode(editBtn, sharedSection);
                }
            } else {
                exitSharedEditMode(editBtn, sharedSection);
            }
        }
        
        // ä¿å­˜å…±äº«å‚æ•°ç¼–è¾‘
        function saveSharedEdit() {
            const editBtn = document.querySelector('.shared-edit-btn');
            const sharedSection = document.querySelector('.shared-params-section');
            
            saveSharedSettings();
            exitSharedEditMode(editBtn, sharedSection);
        }
        
        // å–æ¶ˆç»æµæ¨¡å¼ç¼–è¾‘
        function cancelEconomicEdit() {
            const tabEditBtn = document.querySelector('.tab-button.active .tab-edit-btn');
            const panel = document.getElementById('economic-panel');
            
            if (hasUnsavedChanges || hasUnsavedSharedChanges) {
                if (confirm('æ‚¨æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦å–æ¶ˆå—ï¼Ÿ')) {
                    hasUnsavedChanges = false;
                    hasUnsavedSharedChanges = false;
                    exitEditMode('economic', tabEditBtn, panel);
                }
            } else {
                exitEditMode('economic', tabEditBtn, panel);
            }
        }
        
        // ä¿å­˜ç»æµæ¨¡å¼ç¼–è¾‘
        function saveEconomicEdit() {
            const tabEditBtn = document.querySelector('.tab-button.active .tab-edit-btn');
            const panel = document.getElementById('economic-panel');
            
            // ä¿å­˜ç»æµæ¨¡å¼è®¾ç½®å’Œå…±äº«è®¾ç½®
            saveCurrentTabSettings();
            exitEditMode('economic', tabEditBtn, panel);
        }
        
        // åˆå§‹åŒ–å¯æœç´¢ä¸‹æ‹‰æ¡†
        function initSearchableSelect() {
            const searchInput = document.getElementById('cabinet-search-input');
            const dropdown = document.getElementById('cabinet-dropdown');
            const dropdownItems = dropdown.querySelectorAll('.dropdown-item');
            let selectedValue = null;
            
            // ç‚¹å‡»è¾“å…¥æ¡†æ˜¾ç¤ºä¸‹æ‹‰åˆ—è¡¨
            searchInput.addEventListener('click', function(e) {
                e.stopPropagation();
                dropdown.style.display = 'block';
                highlightCurrentSelection();
            });
            
            // è¾“å…¥æ¡†æœç´¢åŠŸèƒ½
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                let hasVisibleItems = false;
                
                dropdownItems.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    if (text.includes(searchTerm)) {
                        item.style.display = 'block';
                        hasVisibleItems = true;
                    } else {
                        item.style.display = 'none';
                    }
                });
                
                dropdown.style.display = hasVisibleItems ? 'block' : 'none';
            });
            
            // ç‚¹å‡»ä¸‹æ‹‰é¡¹
            dropdownItems.forEach(item => {
                item.addEventListener('click', function() {
                    const value = this.getAttribute('data-value');
                    const text = this.textContent;
                    const demand = this.getAttribute('data-demand');
                    const remaining = this.getAttribute('data-remaining');
                    
                    searchInput.value = text;
                    selectedValue = value;
                    dropdown.style.display = 'none';
                    
                    console.log(`é€‰æ‹©å‚¨èƒ½æŸœ: ${value}, éœ€é‡: ${demand}%, å‰©ä½™: ${remaining}kW`);
                    
                    // æ›´æ–°å³ä¾§æ˜¾ç¤º
                    updateCabinetInfo(demand, remaining);
                    
                    // ç§»é™¤æ‰€æœ‰activeç±»
                    dropdownItems.forEach(i => i.classList.remove('active'));
                    // æ·»åŠ å½“å‰é€‰ä¸­çš„activeç±»
                    this.classList.add('active');
                });
            });
            
            // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰æ¡†
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.searchable-select')) {
                    dropdown.style.display = 'none';
                }
            });
            
            // é«˜äº®å½“å‰é€‰ä¸­é¡¹
            function highlightCurrentSelection() {
                dropdownItems.forEach(item => {
                    if (item.getAttribute('data-value') === selectedValue) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            }
            
            // è®¾ç½®é»˜è®¤é€‰ä¸­ç¬¬ä¸€é¡¹
            if (dropdownItems.length > 0) {
                const firstItem = dropdownItems[0];
                searchInput.value = firstItem.textContent;
                selectedValue = firstItem.getAttribute('data-value');
                firstItem.classList.add('active');
                
                // åˆå§‹åŒ–å³ä¾§æ˜¾ç¤º
                const demand = firstItem.getAttribute('data-demand');
                const remaining = firstItem.getAttribute('data-remaining');
                updateCabinetInfo(demand, remaining);
            }
        }
        
        // æ›´æ–°å‚¨èƒ½æŸœä¿¡æ¯æ˜¾ç¤º
        function updateCabinetInfo(demand, remaining) {
            const demandDisplay = document.getElementById('demand-display');
            const remainingDisplay = document.getElementById('remaining-display');
            
            if (demandDisplay) {
                demandDisplay.textContent = demand + '%';
            }
            if (remainingDisplay) {
                remainingDisplay.textContent = remaining + 'kW';
            }
        }
        
        // åˆå§‹åŒ–ç”µç½‘å……ç”µå¼€å…³
        function initGridChargingSwitch() {
            const gridChargingCheckbox = document.getElementById('grid-charging-enabled');
            const statusText = document.getElementById('grid-charging-status');
            
            if (gridChargingCheckbox && statusText) {
                // é»˜è®¤è®¾ç½®ä¸ºå…³é—­
                gridChargingCheckbox.checked = false;
                updateGridChargingStatus(false);
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                gridChargingCheckbox.addEventListener('change', function() {
                    updateGridChargingStatus(this.checked);
                    console.log('ç”µç½‘å……ç”µè®¾ç½®:', this.checked ? 'å¯ç”¨' : 'ç¦ç”¨');
                });
            }
        }
        
        // æ›´æ–°ç”µç½‘å……ç”µçŠ¶æ€æ˜¾ç¤º
        function updateGridChargingStatus(enabled) {
            const statusText = document.getElementById('grid-charging-status');
            if (!statusText) return;
            
            const lang = localStorage.getItem('language') || 'zh';
            
            if (enabled) {
                statusText.textContent = translations[lang]['economic.gridChargingAllowed'] || 'å…è®¸';
                statusText.setAttribute('data-lang', 'economic.gridChargingAllowed');
                statusText.style.color = '#3b82f6'; // è“è‰²
            } else {
                statusText.textContent = translations[lang]['economic.gridChargingNotAllowed'] || 'ä¸å…è®¸';
                statusText.setAttribute('data-lang', 'economic.gridChargingNotAllowed');
                statusText.style.color = '#94a3b8'; // ç°è‰²
            }
        }
        
        // å…±äº«å‚æ•°åŠŸèƒ½
        function updateSharedTempProtectionStatus() {
            const checkbox = document.getElementById('shared-temp-protection');
            if (!checkbox) return;
            
            const statusText = checkbox.closest('.control-item').querySelector('.control-status');
            
            if (statusText) {
                const lang = localStorage.getItem('language') || 'zh';
                if (checkbox.checked) {
                    statusText.textContent = translations[lang]['shared.enabled'] || 'å·²å¯ç”¨';
                    statusText.style.color = '#22c55e';
                } else {
                    statusText.textContent = translations[lang]['shared.disabled'] || 'å·²ç¦ç”¨';
                    statusText.style.color = '#ef4444';
                }
            }
        }
        
        // éœ€é‡è®¾ç½®å¼€å…³åŠŸèƒ½
        function updateDemandSettingsStatus() {
            const checkbox = document.getElementById('demand-settings-enabled');
            if (!checkbox) return;
            
            const statusText = checkbox.closest('div').querySelector('.status-text');
            
            if (statusText) {
                const lang = localStorage.getItem('language') || 'zh';
                if (checkbox.checked) {
                    statusText.textContent = translations[lang]['shared.enabled'] || 'å·²å¯ç”¨';
                    statusText.style.color = '#3b82f6';
                } else {
                    statusText.textContent = translations[lang]['shared.disabled'] || 'å·²ç¦ç”¨';
                    statusText.style.color = '#94a3b8';
                }
            }
        }
        
        function getSharedSettings() {
            return {
                maxSoc: document.getElementById('shared-max-soc').value,
                minSoc: document.getElementById('shared-min-soc').value,
                maxChargePower: document.getElementById('shared-max-charge-power').value,
                maxDischargePower: document.getElementById('shared-max-discharge-power').value,
                tempProtection: document.getElementById('shared-temp-protection').checked,
                commProtocol: document.getElementById('shared-comm-protocol').value
            };
        }
        
        function applySharedSettings() {
            const sharedSettings = getSharedSettings();
            
            // éªŒè¯SOCèŒƒå›´åˆç†æ€§
            const maxSoc = parseInt(sharedSettings.maxSoc);
            const minSoc = parseInt(sharedSettings.minSoc);
            
            if (maxSoc <= minSoc) {
                alert('è­¦å‘Šï¼šæœ€å¤§SOCå¿…é¡»å¤§äºæœ€å°SOCï¼');
                return false;
            }
            
            if (maxSoc - minSoc < 20) {
                alert('æç¤ºï¼šSOCå·¥ä½œèŒƒå›´è¿‡çª„ï¼Œå»ºè®®ä¿æŒè‡³å°‘20%çš„å·®å€¼ä»¥ç¡®ä¿ç³»ç»Ÿæ­£å¸¸è¿è¡Œ');
            }
            
            console.log('å…±äº«å‚æ•°è®¾ç½®:', sharedSettings);
            return sharedSettings;
        }
        
        // ä¿®æ”¹åŸæœ‰çš„åº”ç”¨è®¾ç½®å‡½æ•°ï¼ŒåŒ…å«å…±äº«å‚æ•°
        const originalApplySettings = window.applySettings;
        window.applySettings = function() {
            const sharedSettings = applySharedSettings();
            if (sharedSettings === false) return; // éªŒè¯å¤±è´¥
            
            // åˆå¹¶å…±äº«è®¾ç½®å’Œæ¨¡å¼ç‰¹å®šè®¾ç½®
            const selfConsumptionSettings = {
                mode: 'self-consumption',
                ...sharedSettings,
                chargeStopSoc: document.getElementById('charge-stop-soc').value,
                dischargeStopSoc: document.getElementById('discharge-stop-soc').value,
                excessPvExport: document.getElementById('excess-pv-export').checked,
                timestamp: new Date().toISOString()
            };
            
            console.log('åº”ç”¨å®Œæ•´è®¾ç½®ï¼ˆå…±äº«+è‡ªå‘è‡ªç”¨ï¼‰:', selfConsumptionSettings);
            alert('è®¾ç½®å·²åº”ç”¨');
        };
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–å…±äº«å‚æ•°äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            // åŸæœ‰çš„åˆå§‹åŒ–ä»£ç ...
            
            // åˆå§‹åŒ–æ»‘å—å¡«å……æ•ˆæœ
            const chargeSlider = document.getElementById('charge-stop-soc-slider');
            const dischargeSlider = document.getElementById('discharge-stop-soc-slider');
            
            if (chargeSlider) {
                updateSliderFill(chargeSlider);
            }
            if (dischargeSlider) {
                updateSliderFill(dischargeSlider);
            }
            
            // åˆå§‹åŒ–æ‰€æœ‰é¢æ¿ä¸ºåªè¯»æ¨¡å¼
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.add('readonly-mode');
            });
            
            // åˆå§‹åŒ–å…±äº«å‚æ•°åŒºåŸŸä¸ºåªè¯»æ¨¡å¼
            const sharedSection = document.querySelector('.shared-params-section');
            if (sharedSection) {
                sharedSection.classList.add('readonly-mode');
            }
            
            // åˆå§‹åŒ–ç¬¬ä¸€ä¸ªtabä¸ºæ¿€æ´»çŠ¶æ€
            const firstTab = document.querySelector('.tab-button');
            if (firstTab) {
                firstTab.classList.add('active');
                const firstPanel = document.getElementById('self-consumption-panel');
                if (firstPanel) {
                    firstPanel.classList.add('active');
                }
            }
            
            // åˆå§‹åŒ–éœ€é‡è®¾ç½®å¼€å…³
            const demandSettingsSwitch = document.getElementById('demand-settings-enabled');
            if (demandSettingsSwitch) {
                demandSettingsSwitch.addEventListener('change', function() {
                    updateDemandSettingsStatus();
                });
                // ç«‹å³æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                updateDemandSettingsStatus();
            }
            
            // åˆå§‹åŒ–å¯æœç´¢å‚¨èƒ½æŸœé€‰æ‹©å™¨
            initSearchableSelect();
        });
    </script>
</body>
</html>